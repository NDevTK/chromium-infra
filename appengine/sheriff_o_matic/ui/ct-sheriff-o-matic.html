<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="../lib/sugar.html">
<script src="../scripts/results.js"></script>

<link rel="import" href="../bower_components/app-router/app-router.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../lib/analytics.html">
<link rel="import" href="../lib/ct-scheduled-updater.html">
<link rel="import" href="../model/ct-repositories.html">
<link rel="import" href="../model/ct-failures.html">
<link rel="import" href="../model/ct-tree-list.html">
<link rel="import" href="ct-party-time.html">
<link rel="import" href="ct-results-panel.html">
<link rel="import" href="ct-tree-select.html">
<link rel="import" href="ct-trooper-card.html">
<link rel="import" href="ct-unexpected-failures.html">

<link rel="import" href="../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-menu/core-submenu.html">
<link rel="import" href="../bower_components/core-icons/maps-icons.html">

<polymer-element name="ct-sheriff-o-matic" attributes="tree">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      header {
        -webkit-user-select: none;
        align-items: center;
        background-color: #212121;
        color: white;
        cursor: default;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        font-size: 1.1em;
        padding: 0 5px;
        white-space: nowrap;
      }
      header span {
        color: white;
        display: inline-block;
        padding: 0.25em 4px;
        text-decoration: none;
      }
      #right-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
      }
      ct-last-updated {
        margin: 0 5px;
      }
      core-animated-pages {
        flex: 1;
      }
      core-animated-pages > * {
        overflow: auto;
      }
      :host {
        position: absolute;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }

      core-scaffold::shadow core-toolbar {
        color: #E5E5E5;
        background: black;
      }

      core-scaffold::shadow core-header-panel::shadow core-toolbar {
        background: #FFF;
        color: black;
      }

      #core_header_panel {
        background-color: rgb(255, 255, 255);
      }

      #main_toolbar {
        background: #666;
      }

      #main_menu {
        font-size: 16px;
      }

      #main_pages {
        height: 100%;
      }

      div[tool] {
        width:100%;
      }

      app-router,
      active-route,
      app-route[active="active"] {
        display: block;
      }

      app-route {
        display: none;
      } 
    </style>
    <core-scaffold id="main_scaffold" responsiveWidth="1200px">
      <core-header-panel mode="seamed" id="core_header_panel" navigation flex>
        <core-toolbar id="main_toolbar"></core-toolbar>
        <core-menu valueattr="id" id="main_menu" theme="core-light-theme" on-core-select="{{ menuSelected }}">
          <core-submenu valueattr="id" icon="folder" label="Trees">
            <template repeat="{{ t in treeList.trees }}">
              <paper-item id="{{ t.name }}" label="{{ t.displayName }}" horizontal center layout>
                {{ t.displayName }}
              </paper-item>
            </template>
          </core-submenu>

          <core-submenu valueattr="id" icon="help" label="Help">
            <paper-item id="help_links" label="Useful Links" horizontal center layout>Useful Links</paper-item>
            <paper-item id="help_calendar" label="Rotation Calendar" horizontal center layout>Rotation Calendar</paper-item>
            <paper-item id="health" label="System Health" horizontal center layout>System Health</paper-item>
          </core-submenu>
      </core-menu>
      </core-header-panel>

      <div tool horizontal layout>
        <div flex>Sheriff-O-Matic: {{ page_title }}</div>
        <ct-last-updated date="{{ failures.lastUpdateDate }}"></ct-last-updated>
      </div>

      <div layout vertical>
        <!-- main content area -->
        <div fit>
          <app-router id="router" trailingSlash="ignore" fit mode="pushstate" activate-route-end="{{ routeEnd }}">

            <app-route path="/help_links" fit>
              <h1>Helpful Links</h1>
              <ul>
                <li><a href="https://code.google.com/p/chromium/wiki/UsefulURLs">Useful URLs</a></li>
                <li><a href="http://www.chromium.org/developers/tree-sheriffs/sheriff-details-chromium">How to Sheriff</a></li>
              </ul>
            </app-route>

            <app-route path="/help_calendar" fit>
              <iframe fit src="https://chromium-build.appspot.com/static/rotations.html" width="100%" height="100%"></iframe>
            </app-route>

            <app-route path="/health">
              <div layout vertical>
                <h2>System Health</h2>
                <template repeat="{{ group in failures.failures['health']}}">
                  <template if="{{ group.data.category == 'trooper' }}">
                    <ct-trooper-card class='{{ { snoozed: group.isSnoozed } | tokenList }}' group="{{ group.data }}"></ct-trooper-card>
                  </template>
                </template>
                <template if="{{ failures && !failures.failures['health'] }}">
                  <ct-party-time></ct-party-time>
                </template>
              </div>
            </app-route>

            <app-route path="/:tree" fit on-before-data-binding="{{ modifyTreeModel }}">
               <template>
               <ct-unexpected-failures id="unexpected" tree="{{ tree }}" repositories="{{ repositories }}" failures="{{ failures }}"></ct-unexpected-failures>
               </template>
           </app-route>

            <app-route path="/:tree/failure/:failureGroupKey" on-before-data-binding="{{ modifyFailureGroupModel }}">
              <template>
              <ct-results-panel id="resultsPanel" group="{{ examinedFailureGroup }}" failureGroupKey="{{ failureGroupKey }}" tree="{{ tree || 'chromium' }}"></ct-results-panel>
              </template>
            </app-route>

            <app-route path="/" redirect="/chromium"></app-route>

          </app-router>
        </div>
      </div>
    </core-scaffold>
  </template>
  <script>
    var kUpdateFrequency = 1000 * 30;

    Polymer({
      page_title: "Chromium",
      tree: '',
      treeList: null,
      examinedFailureGroup: null,
      _pendingFailureGroupKey: '',

      menuSelected: function(e, detail, sender) {
        if (!detail.isSelected) {
          return;
        }
        var pageId = detail.item.id;
        if (!pageId) {
          return;
        }

        this.tree = pageId;
        this.page_title = detail.item.innerText;
        this.$.main_scaffold.closeDrawer();
        history.pushState(null, null, pageId);
        this.$.router.go();
      },

      modifyTreeModel: function(e) {
        e.detail.model.repositories = this.repositories;
        e.detail.model.failures = this.failures;
      },

      modifyFailureGroupModel: function(e) {
        e.detail.model.examinedFailureGroup = this.examinedFailureGroup;
        this._pendingFailureGroupKey = e.detail.model.failureGroupKey;
        this.failureGroupKey = e.detail.model.failureGroupKey;
      },

      attached: function() {
        var pathParts = window.location.pathname.split('/');
        this.tree = pathParts[1];
        // This can be called before $ exists.
        // It can also be called for /:tree/examine links, which in
        // this case would trigger a navigation to /:tree when we
        // try to highlight the current tree in the submenu, so
        // we don't highlight anything on the nav menu in that case.
        if (pathParts.length == 2 && this.$) {
          this.$.main_menu.items.forEach(function(submenu) {
            submenu.items.forEach(function(item) {
              if (item.id == this.tree) {
                submenu.selected = this.tree;
                submenu.active = true;
              }
            }, this);
          }, this);
        }
      },

      created: function() {
        this.treeList = new CTTreeList();
        this._defaultPath = '/' + this.treeList.defaultValue();
        this.repositories  = new CTRepositories();
        this.failures = new CTFailures(this.repositories);
        this._updater = new CTScheduledUpdater(this.update.bind(this), kUpdateFrequency);
        this._analytics = new Analytics('UA-55762617-1');
      },

      ready: function() {
        this.update();
      },

      update: function() {
        if (this._promise)
          return;

        this._promise = Promise.all(
          [this.repositories.update(),
           this.failures.update()]).then(this._updateCompleted.bind(this));
      },

      failureGroupKeyChanged: function() {
        this.examinedFailureGroup = null;
        this._pendingFailureGroupKey = this.failureGroupKey;
        this._updateCompleted();
      },

      _updateCompleted: function() {
        this._promise = null;

        // FIXME: Shouldn't have to do this, but $ doesn't contain dynamically inserted
        // elements (app-router dynamically inserts resultsPanel if some other route was
        // in the initial page load).  This logic should probably be pushed down into
        // ct-results-panel and ct-unexpected-failures.
        var unexpected = this.querySelector('::shadow #unexpected');
        if (unexpected) {
          unexpected.update();
        }
        if (!this.failures.failures)
          return;
        if (!this._pendingFailureGroupKey)
          return;
        this.examinedFailureGroup = this.failures.failures[this.tree].find(function(group) {
          return group.key == this._pendingFailureGroupKey;
        }.bind(this));
        var res = this.querySelector('::shadow #resultsPanel');
        if (!res) {
          return;
        }
        res.group = this.examinedFailureGroup;
        if (!this.examinedFailureGroup) {
          this.asyncFire('navigate', {
            url: this.tree,
            replaceState: true
          });
        }

        this._pendingFailureGroupKey = '';
      },
    });
  </script>
</polymer-element>
