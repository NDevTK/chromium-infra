<link rel="import" href="../bower_components/iron-ajax/iron-request.html">

<script>
  function jsonParsePromise(resp) {
    if (!resp.ok) {
      throw Error(resp.statusText);
    }
    return resp.json();
  }
  // Manages annotation state. Includes a localState object, which holds local
  // annotations to alerts.
  AnnotationManagerBehavior = {
    properties: {
      // Local in browser annotations for alerts, like if the alert is collapsed
      // or not.
      localState: {
        type: Object,
        value: function() { return {}; },
      },
    },

    // Compute the annotation for a given alert.
    computeAnnotation: function(annotations, alert) {
      let key = alert.key;

      let ann = annotations[key];
      let returnVal = {
        key: key,
      };

      // We want to make sure snoozed is not undefined because this makes later
      // checks weirdly falsey
      returnVal.snoozed = false;
      if (ann && ann.snoozeTime) {
        returnVal.snoozed = Date.now() < ann.snoozeTime;
      }

      if (ann && ann.bugs != undefined)  {
        returnVal.bugs = ann.bugs;
      }

      if (ann && ann.bug_data != undefined)  {
        returnVal.bugData = ann.bug_data;
      }

      if (ann && ann.comments != undefined)  {
        returnVal.comments = ann.comments;
      }

      returnVal.opened = (ann && ann.opened ) || false;
      return returnVal;
    },

    // Mutating local state. This exists because we often change the value of
    // items in localState. The key to these items is the alert key, which often
    // has periods in it, making calls to notifyPath not work. So, we follow
    // the instructions at
    // https://www.polymer-project.org/1.0/docs/devguide/model-data#override-dirty-check
    mutateLocalState: function(callback){
      let old = this.localState;
      callback(old);
      this.localState = {};
      this.localState = old;
    },

    // Set a key in local state.
    setLocalStateKey: function(key, newValues){
      this.mutateLocalState((newState) => {
        newState[key] = Object.assign(newState[key] || {}, newValues)
      });
    },
  };
</script>
