<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/chopsui/chops-dialog.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../redux/compute-functions.html">
<link rel="import" href="../../redux/redux-mixin.html">
<link rel="import" href="../../mr-comment-content/mr-comment-content.html">
<link rel="import" href="../../mr-user-link/mr-user-link.html">
<link rel="import" href="../mr-compact-comments/mr-compact-comments.html">
<link rel="import" href="../mr-inline-editor/mr-inline-editor.html">
<link rel="import" href="../mr-edit-metadata/mr-edit-metadata.html">
<link rel="import" href="../mr-metadata/mr-metadata.html">
<link rel="import" href="../shared/mr-flt-styles.html">


<dom-module id="mr-approval-card">
  <template>
    <style include="mr-flt-styles">
      :host {
        width: 100%;
        background-color: white;
        font-size: 85%;
        border-bottom: 1px solid hsl(0, 0%, 85%);
        box-sizing: border-box;
        display: block;
        border-left: 4px solid var(--approval-bg-color);
        --approval-bg-color: hsl(227, 20%, 92%);
        --approval-accent-color: hsl(227, 80%, 40%);
      }
      :host(.status-approved) {
        --approval-bg-color: hsl(78, 55%, 90%);
        --approval-accent-color: hsl(78, 100%, 33%);
      }
      :host(.status-pending) {
        --approval-bg-color: hsl(40, 75%, 90%);
        --approval-accent-color: hsl(36, 100%, 45%);
      }
      :host(.status-rejected) {
        --approval-bg-color: hsl(5, 60%, 92%);
        --approval-accent-color: hsl(357, 100%, 40%);
      }
      h3 {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
      }
      mr-edit-metadata {
        width: 600px;
        max-width: 100%;
      }
      mr-inline-editor {
        display: block;
        width: 100%;
        margin-bottom: 0.5em;
        color: hsl(0, 0%, 30%);
        box-sizing: border-box;
        word-wrap: break-word;
        --mr-inline-editor-textarea-min-height: 300px;
      }
      .approver-notice {
        padding: 0.25em 0;
        width: 100%;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        border-bottom: 1px dotted hsl(0, 0%, 83%);
      }
      .card-content {
        box-sizing: border-box;
        padding: 0.5em 16px;
        padding-bottom: 1em;
      }
      .dialog-actions {
        text-align: right;
      }
      .expand-icon {
        margin-right: 8px;
        --iron-icon-fill-color: hsl(0, 0%, 45%);
      }
      .header {
        margin: 0;
        width: 100%;
        border: 0;
        font-size: 120%;
        font-weight: normal;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        flex-direction: row;
        padding: 0.5em 8px;
        background-color: var(--approval-bg-color);
        cursor: pointer;
      }
      .status {
        font-size: 80%;
        color: var(--approval-accent-color);
        margin-left: 32px;
      }
      .survey {
        padding: 1em 0;
        max-height: 500px;
        overflow-y: auto;
        max-width: 100%;
        box-sizing: border-box;
      }
    </style>
    <button class="header" on-click="toggleCard">
      <iron-icon class="expand-icon" icon="[[_expandIcon]]"></iron-icon>
      [[fieldName]]
      <span class="status">
        <iron-icon class="status-icon" icon=[[_statusIcon]]></iron-icon>
        [[_status]]
      </span>
    </button>
    <iron-collapse class="card-content" id="cardCollapse" opened="[[opened]]">
      <div class="approver-notice">
        <template is="dom-if" if="[[_isApprovalOwner]]">
          You are an approver for this bit.
        </template>
        <chops-button on-click="edit">
          <iron-icon icon="create"></iron-icon>
          Edit approval data
        </chops-button>
      </div>
      <mr-metadata
        approval-status="[[_status]]"
        approvers="[[approvers]]"
        setter="[[setter]]"
        field-defs="[[fieldDefs]]"
        field-values="[[fieldValues]]"
      ></mr-metadata>
      <mr-inline-editor
        content="[[_survey.content]]"
        title$="[[fieldName]] Survey"
        edit-text="Edit responses"
        placeholder="Survey content and answer"
        on-save="[[_updateSurvey]]"
      >
        <div class="survey">
          <mr-comment-content content="[[_survey.content]]"></mr-comment-content>
        </div>
      </mr-inline-editor>
      <h3>Approval comments / Changelog</h3>
      <mr-compact-comments
        comments="[[_comments]]"
        on-submit-comment="[[_onSubmitComment]]"
      ></mr-compact-comments>
    </iron-collapse>
    <chops-dialog id="editApproval" aria-labelledby="approvalDialogTitle">
      <h3 id="approvalDialogTitle">
        Editing approval: [[phaseName]] &gt; [[fieldName]]
      </h3>
      <mr-edit-metadata
        id="metadataForm"
        approvers="[[approvers]]"
        field-defs="[[fieldDefs]]"
        field-values="[[fieldValues]]"
        statuses="[[_availableStatuses]]"
        status="[[_status]]"
        is-approver="[[_isApprovalOwner]]"
        is-approval
      ></mr-edit-metadata>
      <div class="dialog-actions">
        <chops-button on-click="cancel" class="de-emphasized">
          <iron-icon icon="close"></iron-icon>
          Cancel
        </chops-button>
        <chops-button on-click="save" class="emphasized">
          <iron-icon icon="create"></iron-icon>
          Save changes
        </chops-button>
      </div>
    </chops-dialog>
  </template>
  <script src="./mr-approval-card.js"></script>
<dom-module>
