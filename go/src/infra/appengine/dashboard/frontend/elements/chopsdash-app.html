<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/elements/last-updated-message.html">
<link rel="import" href="/elements/tree-status.html">
<link rel="import" href="/elements/status-table.html">

<script src="/bower_components/moment/min/moment.min.js"></script>
<script src="/bower_components/moment-timezone/builds/moment-timezone-with-data.min.js"></script>

<dom-module id="chopsdash-app">
  <template>
    <style>
      #app {
        background-color: #f4f4f4;
        font-family: 'Roboto', 'Noto', sans-serif;
      }
      app-header {
        --app-header-shadow: {
          box-shadow: inset 0px 5px 2px -3px rgba(0, 0, 0, 0.9);
        };
        background-color: #4285f4;
        color: white;
      }
      .content {
        padding: 30px;
      }
      .subtext {
        font-size: .80em;
      }
      .table {
        padding: 20px 0px;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="/static/icons.css">
    <iron-ajax
      id="ajax"
      url="/prpc/dashboard.ChopsServiceStatus/GetAllServicesData"
      method="POST"
      content-type="application/json"
      accept="json"
      json-prefix=")]}'"
      on-response="_refreshCountdown"
      handle-as="json"
      last-response="{{ajaxResponse}}"
      ></iron-ajax>
    <div id="app">
      <app-header reveals effects="waterfall">
        <app-toolbar>
          <div main-title>Chrome Operations Status Dashboard</div>
          <last-updated-message last-updated="[[lastUpdated]]"></last-updated-message>
        </app-toolbar>
      </app-header>
      <div class="content">
        <tree-status></tree-status>
        <!-- TODO(jojwang): Only the second table is showing up because none of our services have SLAs.
          When there are both tables become visible on the dashboard make it clear to users
          that one table is for services covered by an SLA and one is not.-->
        <template is="dom-if" if="[[services.length]]">
          <div class="table">
            <status-table services="[[services]]" latest-date-ts="{{latestDateTs}}">
          </status-table>
          </div>
        </template>
        <template is="dom-if" if="[[nonSLAServices.length]]">
          <div class="table">
            <status-table services="[[nonSLAServices]]" latest-date-ts="{{latestDateTs}}">
            </status-table>
          </div>
        </template>
        <p class="subtext">
          <i class="green circle"></i> No issues<br/>
          <i class="yellow circle"></i> Slow or experiencing disruptions<br/>
          <i class="red circle"></i> Service outage<br/>
          <p class="subtext">
            Click
            <a href="https://docs.google.com/a/chromium.org/document/d/1Hil4mCU_t98RZcX4Tly7kQ2hAry2r1gympqTXOgqGlY/edit?usp=sharing">
              here
            </a>
            for more detailed status definitions.
          </p>
        </p>
        <p class="subtext">
          All dates shown are using the local timezone unless otherwise specified.
        </p>
      </div>
    <div>
  </template>
  <script>
    'use strict';
    // Any timestamps received from or sent to the backend are in seconds.
    // Any timestamps created/used in the frontend will be
    // (converted to, if necessary) in  milliseconds.
    const RELOAD_TIME_MIN = 5;
    const UPDATE_MESSAGE_TIME = 60 * 1000;

    class ChOpsDashApp extends Polymer.Element {
      static get is() { return 'chopsdash-app'; }

      ready() {
        super.ready();
        this._refreshData();
      }

      static get properties() {
        return {
          // latestDateTs is a timestamp in milliseconds.
          latestDateTs: {
            type: Number,
            notify: true,
            value: new Date().setHours(23, 50, 50, 0),
            observer: '_refreshData',
          },
          // Services covered by an SLA.
          services: {
            type: Array,
            computed: '_updateServices(ajaxResponse)'
          },
          // Services that are not covered by an SLA.
          nonSLAServices: {
            type: Array,
            computed: '_updateNonSLAServices(ajaxResponse)'
          },
          lastUpdated: {
            type: Object,
            value: {time: moment(Date.now()).format('M/DD/YYYY, h:mm a'), relativeTime: 0}
          }
        }
      }

      _refreshData() {
        let body = {uptoTime: Math.floor(this.latestDateTs / 1000)};
        this.$.ajax.body = JSON.stringify(body);
        this.$.ajax.generateRequest();
      }

      _refreshCountdown() {
        this._countdown(0);
      }

      _countdown(lastRefresh) {
        if (lastRefresh == RELOAD_TIME_MIN) {
          this.set('lastUpdated.relativeTime', 0);
          this.set('lastUpdated.time', moment(Date.now()).format('M/DD/YYYY, h:mm a'));
          this._refreshData();
        } else {
          Polymer.Async.timeOut.run(() => {
            this.set('lastUpdated.relativeTime', lastRefresh + 1);
            this._countdown(lastRefresh + 1); }, UPDATE_MESSAGE_TIME);
        }
      }

      _updateServices(jsonData) {
        return jsonData.services;
      }

      _updateNonSLAServices(jsonData) {
        return jsonData.nonslaServices;
      }
    }
    customElements.define(ChOpsDashApp.is, ChOpsDashApp);
  </script>
</dom-module>
