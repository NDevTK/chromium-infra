<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-page-url/iron-page-url.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../elements/som-alert-item.html">
<link rel="import" href="../elements/som-drawer.html">

<dom-module id="som-app">
  <template>
    <style>
      paper-toolbar {
        --paper-toolbar-background: black;
      }
      .last-updated {
        text-align: right;
        padding-right: 1em;
      }
      #alerts {
        @apply(--layout-vertical);
        @apply(--center-justified);
        margin: 0 auto;
        padding: 8px;
        height: 100%;
      }
      paper-header-panel[main] {
        --paper-header-panel-body: {
          background: #eee;
        }
      }
     .title {
        font-size: big;
      }
      .som-title {
        font-weight: bold;
      }
      iron-list {
        overflow: none;
        --iron-list-items-container: {
          margin: auto;
          margin-bottom: 60px;
          border-bottom: 1px solid #ddd;
        };
      }
      .list-item {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        margin-bottom: 10px;
      }
      .file-bug,
      .snooze {
        color: #aaa;
      }
    </style>
    <iron-page-url id="url" path="{{_path}}"></iron-page-url>
    <iron-ajax
        auto
        id="alertsAjax"
        loading="{{_networkActive}}"
        url="/api/v1/alerts/[[_alertsGroup]]"
        handle-as="json"
        last-error="{{_alertsJsonError}}"
        last-response="{{_alertsJson}}"
        debounce-duration="300"></iron-ajax>
    <iron-ajax
        auto
        id="annotations"
        url="/api/v1/annotations"
        handle-as="json"
        last-error="{{_annotationsJsonError}}"
        last-response="{{annotationsJson}}"
        debounce-duration="300"></iron-ajax>
    <iron-ajax
        id="annotationPost"
        method="post"
        handle-as="json"
        last-error="{{_annotationPostError}}"
        on-response="_postResponse"></iron-ajax>
    <paper-drawer-panel responsive-width="1024px">
      <paper-header-panel drawer>
        <paper-toolbar>
          <span class="som-title">Sheriff-o-Matic</span>
        </paper-toolbar>
        <som-drawer id="drawer" selected-alerts-group="{{_alertsGroup}}"></som-drawer>
      </paper-header-panel>
      <paper-header-panel main>
        <paper-toolbar>
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <div class="layout horizontal flex">
            <div class="flex title">[[_alertsGroup]]</div>
            <div class="flex last-updated">Last updated: [[_lastUpdated]]</div>
            <iron-icon icon="refresh"></iron-icon>
          </div>
          <paper-spinner active="[[_networkActive]]"></paper-spinner>
        </paper-toolbar>
        <iron-list id="alertsList" items="[[_alerts]]" as="alert" class="fit" selection-enabled multi-selection>
          <template>
            <div class="list-item" tabindex$="[[tabIndex]]">
              <som-alert-item
                  alert="{{alert}}"
                  selected="[[selected]]"
                  annotation="[[_computeAnnotation(annotations,alert)]]"
                  on-selected-changed="_handleCardSelected"
                  on-annotation-change="_handleAnnotation"
              ></som-alert-item>
            </div>
          </template>
        </iron-list>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'som-app',

      attached: function() {
        this._alertsGroup = this.$.url.path.split('/')[1];
      },

      properties: {
        _alertsGroup: {
          type: String,
          value: 'chromium',
          observer: '_handleAlertsGroupChange',
        },
        _path: {
          type: String,
          value: '/chromium',
          observer: '_handlePathChange'
        },
        _alertsJson: {
          type: Object,
          value: function() { return {}; }
        },
        _alerts: {
          type: Array,
          computed: '_computeAlerts(_alertsJson, annotations)',
        },
        // We don't convert the array into an object because the polymer data
        // binding doesn't seem to like mutations to an object, but it's fine
        // watching and notifying about changes to an array :/
        annotations: {
          type: Object,
          computed: '_computeAnnotations(annotationsJson)',
        },
        annotationsJson: Array,
        _lastUpdated: {
          type: Date,
          computed: '_computeLastUpdated(_alertsJson.timestamp)'
        },
        _networkActive: {
          type: Boolean,
          value: false
        },
        _alertsJsonError: {
          type: Object,
          value: function() { return {}; }
        },
         _annotationsJsonError: {
          type: Object,
          value: function() { return {}; }
        },
        _annotationPostError: {
          type: Object,
          value: function() { return {}; }
        },
      },

      _handleAlertsGroupChange: function(newVal) {
        this._path = '/' + newVal;
      },

      _handlePathChange: function(newVal) {
        this._alertsGroup = newVal.split('/')[1];
      },

      _computeLastUpdated: function(lastPosted) {
        if (lastPosted != undefined) {
          return new Date(lastPosted * 1000).toLocaleString();
        }
        return '';
      },

      _computeAlerts: function(alertsJson, annotations) {
        if (!alertsJson.alerts) {
          return [];
        }
        alertsJson.alerts.sort((a, b) => {
          let aAnn = this._computeAnnotation(annotations, a);
          let bAnn = this._computeAnnotation(annotations, b);

          if (aAnn.snoozed == bAnn.snoozed) {
            return a.severity - b.severity;
          }

          return aAnn.snoozed ? 1 : -1;
        });

        return alertsJson.alerts;
      },

      _computeAnnotations: function(annotationsJson) {
        let annotations = {};
        if (!annotationsJson) {
          return annotations;
        }
        annotationsJson.forEach(function(annotation) {
          annotations[annotation.key] = annotation;
        });
        return annotations;
      },

      _computeAnnotation: function(annotations, alert) {
        let key = this._keyForAlert(alert);

        let ann = annotations[key];
        return {
          key: key,
          snoozed: ann && ann.snoozeTime ? Date.now() < ann.snoozeTime : false,
        };
      },

      _handleAnnotation: function(evt) {
        let changes = evt.detail.changes;
        let key = this._keyForAlert(evt.model.alert);
        this.$.annotationPost.body = JSON.stringify(changes);
        this.$.annotationPost.url = '/api/v1/annotations/' + key;
        this.$.annotationPost.generateRequest();
      },

      _postResponse: function(evt) {
        let response = evt.detail.response;
        let annotations = this.annotations;
        annotations[response.key] = response;
        let newArray = [];
        Object.keys(annotations).forEach(function(k) {
          newArray.push(annotations[k]);
        });
        this.annotationsJson = newArray;
        // Kind of a cheat: we aren't resizing anything necessarily but we
        // do want to tickle the list order.
        setTimeout( ()=> {
          this.$.alertsList.notifyResize();
        }, 250);
      },

      _keyForAlert: function(alert) {
        if (alert.extension && alert.extension.reasons &&
            alert.extension.builders) {
          return alert.extension.reasons.map(function(reason) {
            return reason.step;
          }).concat(alert.extension.builders.map(function(builder) {
            return builder.name;
          })).join('::');
        }
        return null;
      },
    });
  })();
  </script>
</dom-module>
