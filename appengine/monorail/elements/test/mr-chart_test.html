<meta charset="utf-8">
<script src="/bower_components/web-component-tester/browser.js"></script>
<script type="module" src="/static/js/elements/mr-chart.js"></script>

<test-fixture id="basic">
  <template>
    <mr-chart project-name="rutabaga"></mr-chart>
  </template>
</test-fixture>

<script type="module">
import MrChart from '../../static/js/elements/mr-chart.js';
import '../../bower_components/chopsui/prpc-client.js';

suite('basic tests', function() {
  let element;

  setup(function() {
    sinon.stub(window, 'fetch', () => {
      return new Promise((resolve, reject) => {
        // TODO: Export prefix from prpc-client and use that.
        const xssiPrefix = ')]}\'';
        const dataStr = JSON.stringify({
          snapshotCount: [{count: 0}],
          unsupportedField: [],
        });
        const responseBody = new Blob([xssiPrefix + dataStr]);

        resolve(new Response(responseBody, {
          status: 201,
          headers: {
            'Content-type': 'application/json',
            'X-Prpc-Grpc-Code': 0,
          },
        }));
      });
    });
    // Stub RAF to execute immediately.
    sinon.stub(window, 'requestAnimationFrame', (func) => func());

    window.prpcClient = new window.chops.rpc.PrpcClient();
    element = fixture('basic');
  });

  teardown(function() {
    window.fetch.restore();
    window.requestAnimationFrame.restore();
  });

  test('sets this.projectname', () => {
    assert.equal(element.projectName, 'rutabaga');
  });

  test('sends data request after instantiation', () => {
    assert.equal(window.fetch.getCalls().length, 14);
  });

  test('sortInBisectOrder orders first, last, median recursively', function() {
    assert.deepEqual(MrChart.sortInBisectOrder([]), []);
    assert.deepEqual(MrChart.sortInBisectOrder([9]), [9]);
    assert.deepEqual(MrChart.sortInBisectOrder([8, 9]), [8, 9]);
    assert.deepEqual(MrChart.sortInBisectOrder([7, 8, 9]), [7, 9, 8]);
    assert.deepEqual(
      MrChart.sortInBisectOrder([1, 2, 3, 4, 5]), [1, 5, 3, 2, 4]);
  });

  test('progress bar shown initially, updated after data', async () => {
    assert.equal(element.progressBar.style.visibility, 'visible');
    assert.equal(element.progressBar.value, 0.05);

    await element._fetchData([12345678]);

    assert.equal(element.progressBar.style.visibility, 'hidden');
    assert.equal(element.progressBar.value, 1);
  });
});
</script>
