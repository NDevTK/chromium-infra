<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">

<dom-module id="crdx-bug-input">
  <template>
    <paper-input
      label="[[inputLabel]]"
      value="{{_bug}}"
      auto-validate
      pattern="[[_bugPattern]]"
      error-message="Please enter a bug id or bug url">
    </paper-input>
  </template>
  <script>
    'use strict';

    const bugIdRe = /[0-9]{3,}/;
    const bugRe = /([^0-9]*)?[0-9]{3,}([^0-9]*)?/;
    const bugProjectUrlRe = /(\/p\/[a-z0-9][-a-z0-9]*[a-z0-9]\/)/i;
    const bugProjectPairRe = /([a-z0-9][-a-z0-9]*[a-z0-9]:)/i;
    const bugProjectNameRe = /[a-z0-9][-a-z0-9]*[a-z0-9]/i;

    /**
     * `<crdx-bug-input>` is an input element for crbug urls and bug ids.
     *
     * `<crdx-bug-input>` does validation on the input and puts the final bug id in
     * the bugId property. If the input is invalid, this will be expressed in
     * the invalidBug property.
     *
     *
     * @customElement
     * @polymer
     * @demo /demo/crdx-bug-input_demo.html
     */
    class CrdxBugInput extends Polymer.Element {
      static get is() { return 'crdx-bug-input'; }

      static get properties() {
        return {
          _bug: String,
          /** The input label for the user inputting the bug with 'Bug # or URL' default. */
          inputLabel: {
            type: String,
            value: 'Bug # or URL',
          },
          /** True if the given bug is an invalid id or url. */
          invalidBug: {
            type: Boolean,
            notify: true,
            computed: '_computeInvalidBug(bugId)',
          },
          /** The final bug id. */
          bugId: {
            type: String,
            notify: true,
            computed: '_computeBugId(_bug)',
          },
          /** The final bug project name. */
          bugProject: {
            type: String,
            notify: true,
            computed: '_computeBugProject(_bug)',
          },
        }
      }

      _computeBugId(bug) {
        return bugRe.test(bug) ? bugIdRe.exec(bug) : 'Unknown';
      }

      _computeBugProject(bug) {
        let cleanBug = bug.replace(/http(s?):/i, "");
        let projectSection = bugProjectUrlRe.exec(cleanBug) || bugProjectPairRe.exec(cleanBug);
        return projectSection ? bugProjectNameRe.exec(projectSection)[0] : 'chromium';
      }

      _computeInvalidBug(bugId) {
        return bugId == 'Unknown';
      }

    }
    customElements.define(CrdxBugInput.is, CrdxBugInput);
  </script>
<dom-module>
