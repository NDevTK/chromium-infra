<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-page-url/iron-page-url.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">

<dom-module id="som-extension-build-failure">
  <template>
    <style>
     .builder {
        border-radius: 2px;
        border: 1px solid #dcdcdc;
        font-size: smaller;
        margin: 0.1em;
        padding: 0.5em;
        display: inline-block;
        background: #E75D54;
        color: #f4f4f4;
      }
      .infra-failure {
        background: #e0b0ff;
        color: #fff;
      }
     .builder a {
        font-weight: bold;
        text-decoration: none;
        color: white;
      }
      .infra-failure a {
        color: white;
      }
      .builder a:hover {
        text-decoration: underline;
      }
      #builders {
        margin: 0.5em 0;
      }
      #reasons {
        margin: 0.5em;
      }
      #regression-ranges {
        margin: 0.5em;
      }
      .codesearch-link {
        font-size: smaller;
      }
    </style>
    <div>
      <div id="builders">
        <template is="dom-repeat" items="[[extension.builders]]" as="builder">
          <span class$="[[_classForBuilder(builder)]]">
            <a target="_blank" href$="[[builder.url]]" title$="Failing for the last [[_failureCount(builder)]] build(s): [[builder.first_failure]] - [[builder.latest_failure]].">
                [[builder.name]]
                [[_failureCount(builder)]]
            </a>
          </span>
        </template>
      </div>
      <div id="reasons">
        <template is="dom-repeat" items="[[extension.reasons]]" as="reason">
          <div>
            <a target="_blank" href$="[[reason.url]]">[[reason.step]]</a>
            <ul>
              <template is="dom-repeat" items="[[reason.test_names]]" as="testName">
                <li>
                  [[testName]]
                  <a class='codesearch-link' target="_blank" href="https://cs.chromium.org/[[testName]]">
                    CS
                  </a>
                </li>
              </template>
            </ul>
          </div>
        </template>
      </div>
      <div id="regression-ranges">
        <template is="dom-repeat" items="[[extension.regression_ranges]]" as="regressionRange" filter="_showRegressionRange">
          <div>
            [[regressionRange.repo]]:
            <a target="_blank" href$="[[_regressionRangeLink(regressionRange)]]">[[_regressionRange(regressionRange)]]</a>
          </div>
        </template>
      </div>
    </div>
  </template>
  <script>
  (function() {
    'use strict';

     Polymer({
      is: 'som-extension-build-failure',

      properties: {
        extension: {
          type: Object,
          value: null
        },
        type: {
          type: String,
          value: ''
        },
      },

     _regressionRange: function(range) {
        if (!range.positions || range.positions.length == 0) {
          return '';
        }

        let start = this._parseCommitPosition(range.positions[0]);
        if (range.positions.length == 1) {
          return start;
        }

        let end = this._parseCommitPosition(
            range.positions[range.positions.length - 1]);

        if (start && end) {
          return `${start} - ${end}`;
        }
      },

      _regressionRangeLink: function(range) {
        if (!range.positions) {
          return '';
        }
        let end = this._parseCommitPosition(range.positions[0]);
        let start = end;
        if (range.positions.length > 1) {
          end = this._parseCommitPosition(
              range.positions[range.positions.length - 1]);
        }
        return 'http://test-results.appspot.com/revision_range?start=' +
            `${start}&end=${end}`;
      },

      _parseCommitPosition: function(pos) {
        let groups = /refs\/heads\/master@{#([0-9]+)}/.exec(pos);
        if (groups && groups.length == 2) {
          return groups[1];
        }
      },

      _failureCount: function(builder) {
        // The build number range is inclusive.
        let numBuilds = builder.latest_failure - builder.first_failure + 1;
        if (numBuilds > 1) {
          return `[${numBuilds} in a row]`;
        }
      },

      _classForBuilder: function(builder) {
        let classes = ['builder']
        if (this._failureCount(builder) > 1) {
          classes.push('multiple-failures');
        }
        if (this.type == 'infra-failure') {
          classes.push('infra-failure');
        }
        return classes.join(' ');
      },

      _showRegressionRange: function(range) {
        return this._regressionRange(range) && range.positions.length > 0;
      },
    });
  })();
  </script>
</dom-module>
