<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html> 
  <head> 
    <meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type"> 
  </head> 
  <body> 
    <script type="application/javascript"> 
      String.prototype.startsWith = function(str) {
        return (this.match('^' + str) == str)
      }
 
      // Helper function to retrieve the value of a GET query parameter.
      // Greatly inspired from http://alturl.com/8rj7a
      function getParameter(parameterName) {
        // Add '=' to the parameter name (i.e. parameterName=value)
        var parameterName = parameterName + '=';
        var queryString = window.location.search.substring(1);
        if (queryString.length <= 0) {
          return '';
        }
        
        // Find the beginning of the string
        begin = queryString.indexOf(parameterName);
 
        // If the parameter name is not found, skip it, otherwise return the
        // value.
        if (begin == -1) {
          return '';
        }
         
        // Add the length (integer) to the beginning.
        begin += parameterName.length;
 
        // Multiple parameters are separated by the '&' sign.
        end = queryString.indexOf ('&', begin);
        
        if (end == -1) {
          end = queryString.length;
        }
        
        // Return the string.
        return unescape(queryString.substring(begin, end));
      }
 
      // Given a tag and a node, returns the value for this tag on this node.
      function getNodeValue(node, tag) {
        return node.getElementsByTagName(tag)[0].firstChild.nodeValue;
      }

      // Displays the directory listing given the XML and path.
      function displayList(xmlstring, root, path) {
        // Display the header
        document.write('<h1>Index of /' + path + '</h1>');
 
        // Start the table for the results.
        document.write('<table style="border-spacing:15px 0px;">');
 
        // Display the table header.
        document.write('<tr><th><img src="' + root +
                       'icons/blank.gif" alt="[ICO]"></th>');
        document.write('<th>Name</th>');
        document.write('<th>Last modified</th>');
        document.write('<th>Size</th>');
        document.write('<th>Storage Class</th>');
        document.write('<th>ETag</th></tr>');
        document.write('<tr><th colspan="6"><hr></th></tr>');
 
        // Display the 'go back' button.
        if (path != '') {
          var backpath = location.pathname;
 
          // If there is more than one section delimited by '/' in the current
          // path we truncate the last section and append the rest to backpath.
          delimiter = path.lastIndexOf('/');
          if (delimiter >= 0) {
            delimiter = path.substr(0, delimiter).lastIndexOf('/');
            if (delimiter >= 0) {
              backpath += '?path=';
              backpath += path.substr(0, delimiter+1);
            }
          }
 
          document.write('<tr><td valign="top"><img src="' + root +
                         'icons/back.gif" alt="[DIR]"></td>');
          document.write('<td><a href="');
          document.write(backpath);
          document.write('">Parent Directory</a></td>');
          document.write('<td>&nbsp;</td>');
          document.write('<td align="right">  - </td></tr>'); 
        }
 
        // Parse the XML output.
        parser = new DOMParser();
        xmlDoc = parser.parseFromString(xmlstring, 'text/xml');
 
        // Set up the variables.
        var directories = new Array();
        var files = new Array();

        // Get the main element.
        var results = xmlDoc.getElementsByTagName('ListBucketResult');
 
        // Get IsTruncated.
        var truncated = getNodeValue(results[0], 'IsTruncated');
        var nextMarker = ''
        if (truncated == 'true') {
          nextMarker = getNodeValue(results[0], 'NextMarker');
        }
      
        // Get all the directories.
        var prefixes = results[0].getElementsByTagName('CommonPrefixes');
        for (var i = 0; i < prefixes.length; i++) {
          var prefix = getNodeValue(prefixes[i], 'Prefix');
          directories.push(prefix.substr(path.length));
        }
      
        // Get all the files.
        var contents = results[0].getElementsByTagName('Contents');
        for (var i = 0; i < contents.length; i++) {
          var obj = new Object();
          obj.keyName = getNodeValue(contents[i], 'Key');
          obj.lastModified = getNodeValue(contents[i], 'LastModified');
          obj.eTag = getNodeValue(contents[i], 'ETag');
          obj.size = getNodeValue(contents[i], 'Size');
          obj.storageClass = getNodeValue(contents[i], 'StorageClass');
          files.push(obj);
        }
 
        // TODO(nsylvain): Sort the arrays. (Size, name, last modified).
      
        // Display the directories.
        for (var i = 0; i < directories.length; i++) {
          var link = location.pathname.substr(0, location.pathname.indexOf('?'));
          link += '?path=' + path + directories[i];
      
          document.write('<tr>');
          document.write('<td valign="top"><img src="' + root +
                         'icons/folder.gif" alt="[DIR]"></td>');
          document.write('<td><a href="' + link + '">' +
                         directories[i].split('/')[0] + '</a></td>');
          document.write('<td align="right">-</td>');
          document.write('<td align="right">-</td>');
          document.write('<td align="right">-</td>');
          document.write('<td align="right">-</td>');
          document.write('</tr>');
        }
      
        // Display the files.
        for (var i = 0; i < files.length; i++) {
          var link = root + files[i].keyName;
          var filename = files[i].keyName.substr(path.length);
          var size = files[i].size / 1024 / 1024;
          var lastModified = files[i].lastModified.replace('T', ' ');
          lastModified = lastModified.substr(0, lastModified.indexOf('.'));
          
          // Remove the entries we don't want to show.
          if (filename == '') {
            continue;
          }
        
          if (filename.indexOf('$folder$') >= 0) {
            continue;
          }
        
          // Display the row.
          document.write('<tr>');
          document.write('<td valign="top"><img src="' + root +
                         'icons/binary.gif" alt="[DIR]"></td>');
          document.write('<td><a href="' + link + '">' + filename +
                         '</a></td>');
          document.write('<td align="right">' + lastModified + '</td>');
          document.write('<td align="right">' + size.toFixed(2) + 'MB</td>');
          document.write('<td align="right">' + files[i].storageClass +
                         '</td>');
          document.write('<td align="right"><pre>' +
                         files[i].eTag.split('"')[1] + '</pre></td>');
          document.write('</tr>');
        }
 
        // Close the table.
        document.write('<tr><th colspan="6"><hr></th></tr>');
        document.write('</table>');

        if (truncated == 'true') {
          morePath = location.pathname + '?marker=' + nextMarker +
                     '&path=' + path;
          document.write('The results were truncated to 1000 lines. ');
          document.write('<a href="' + morePath + '">Load More</a>');
        }
      }
 
      function fetchAndDisplay() {
        path = getParameter('path');
        marker = getParameter('marker');
        filename = location.pathname.substring(location.pathname.lastIndexOf("/")+1);
        root = location.pathname.substring(0, location.pathname.lastIndexOf("/")+1);

        markerParam = '';
        if (marker != '') {
          markerParam = '&marker=' + marker;
        }

        http = new XMLHttpRequest();
        http.open('GET', root + '?delimiter=/&prefix=' + path + markerParam,
                  true);
        http.onreadystatechange = useHttpResponse;
        http.send(null);
        function useHttpResponse() {
          if (http.readyState == 4) {
            var textout = http.responseText;
            displayList(textout, root, path);
          }
        }
      }
      
      fetchAndDisplay();
    </script> 
  </body> 
</html>
