<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/chopsui/chops-dialog.html">
<link rel="import" href="../../../bower_components/chopsui/chops-timestamp.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../mr-user-link/mr-user-link.html">
<link rel="import" href="../mr-edit-metadata/mr-edit-metadata.html">
<link rel="import" href="../shared/mr-flt-styles.html">
<link rel="import" href="../../mixins/redux-mixin.html">

<dom-module id="mr-metadata">
  <template>
    <style include="mr-flt-styles">
      :host {
        box-sizing: border-box;
        padding: 0.5em 8px;
        max-width: 100%;
        display: block;
      }
      a.label {
        color: hsl(120, 100%, 25%);
        text-decoration: none;
      }
      a.label[data-derived] {
        font-style: italic;
      }
      chops-button {
        border: 1px solid hsl(120, 15%, 90%);
      }
      mr-edit-metadata {
        width: 800px;
        max-width: 100%;
      }
      table {
        table-layout: fixed;
        width: 100%;
      }
      td, th {
        padding: 0.5em 4px;
        vertical-align: top;
      }
      td {
        text-overflow: ellipsis;
        overflow: hidden;
        width: 60%;
      }
      th {
        text-align: left;
      }
      .dialog-actions {
        text-align: right;
      }
      .edit-container {
        text-align: center;
        box-sizing: border-box;
        padding: 0.5em 8px;
        border-top: 1px solid hsl(120, 15%, 90%);
      }
      .restricted {
        background: hsl(30, 100%, 93%);
        border: 1px solid hsl(30, 40%, 85%);
        width: 100%;
        box-sizing: border-box;
        padding: 0.5em 8px;
        margin: 1em auto;
      }
      .restricted iron-icon {
        --iron-icon-fill-color: hsl(30, 5%, 39%);
      }
      .restricted strong {
        display: block;
        text-align: center;
        width: 100%;
        margin-bottom: 0.5em;
      }
    </style>
    <table>
      <tr>
        <th>Owner:</th>
        <td>
          <mr-user-link
            display-name="[[issue.ownerRef.displayName]]"
            user-id="[[issue.ownerRef.userId]]"
          ></mr-user-link>
        </td>
      </tr>
      <tr hidden$="[[!issue.ccRefs.length]]">
        <th>CC:</th>
        <td>
          <template is="dom-repeat" items="[[issue.ccRefs]]">
            <mr-user-link
              display-name="[[item.displayName]]"
              user-id="[[item.userId]]"
            ></mr-user-link><br />
          </template>
        </td>
      </tr>
      <template is="dom-repeat" items="[[users]]" as="user">
        <tr>
          <th>[[user.name]]:</th>
          <td>
            <template is="dom-repeat" items="[[user.values]]">
              <mr-user-link
                display-name="[[item]]"
                user-id="[[item]]"
              ></mr-user-link><br />
            </template>
          </td>
        </tr>
      </template>

      <tr>
        <th>Status:</th>
        <td>
          [[issue.statusRef.status]]
          <em hidden$="[[!issue.statusRef.meansOpen]]">
            (Open)
          </em>
          <em hidden$="[[issue.statusRef.meansOpen]]">
            (Closed)
          </em>
        </td>
      </tr>

      <tr hidden$="[[!issue.componentRefs.length]]">
        <th>Components:</th>
        <td>
          <template is="dom-repeat" items="[[issue.componentRefs]]">
            <a href$="/p/[[item.projectName]]/issues/list?q=component:[[item.path]]">
              [[item.path]]
            </a>
          </template>
        </td>
      </tr>

      <template is="dom-repeat" items="[[_fieldList]]" as="field">
        <tr>
          <th>[[field.fieldRef.fieldName]]:</th>
          <td>
            <template is="dom-if" if="[[_fieldIsUrl(field.fieldRef.type)]]">
              <template is="dom-repeat" items="[[field.values]]" as="value">
                <a href$="[[value]]">[[value]]</a>
              </template>
            </template>

            <template is="dom-if" if="[[_fieldIsUser(field.fieldRef.type)]]">
              <template is="dom-repeat" items="[[field.values]]" as="value">
                <mr-user-link
                  user-id="[[value]]"
                  display-name="[[value]]"
                ></mr-user-link>
              </template>
            </template>

            <template is="dom-if" if="[[_fieldIsRemainingTypes(field.fieldRef.type)]]">
              <template is="dom-repeat" items="[[field.values]]" as="value">
                <a href$="/p/[[issue.projectName]]/issues/list?q=[[field.fieldRef.fieldName]]=&quot;[[value]]&quot;">
                  [[value]]</a><span hidden$="[[_isLastItem(field.values.length,index)]]">,</span>
              </template>
            </template>
          </td>
        </tr>
      </template>

      <template is="dom-if" if="[[issue.blockedOnIssueRefs.length]]">
        <tr>
          <th>BlockedOn:</th>
          <td>
            <template is="dom-repeat" items="[[issue.blockedOnIssueRefs]]">
              <a href$="/p/[[item.projectName]]/issues/approval?id=[[item.localId]]">
                Issue [[item.localId]]</a>
              <br />
            </template>
          </td>
        </tr>
      </template>

      <template is="dom-if" if="[[issue.blockingIssueRefs.length]]">
        <tr>
          <th>Blocking:</th>
          <td>
            <template is="dom-repeat" items="[[issue.blockingIssueRefs]]">
              <a href$="/p/[[item.projectName]]/issues/approval?id=[[item.localId]]">
                Issue [[item.localId]]</a>
              <br />
            </template>
          </td>
        </tr>
      </template>
      <tr>
        <th>Modified:</th>
        <td>
          <chops-timestamp timestamp="[[issue.modifiedTimestamp]]" short></chops-timestamp>
        </td>
      </tr>
    </table>

    <div class="labels-container">
      <template is="dom-repeat" items="[[issue.labelRefs]]" as="label">
        <a href$="/p/[[item.projectName]]/issues/list?q=label:[[label.label]]" class="label" data-derived$="[[label.isDerived]]">[[label.label]]</a>
        <br />
      </template>
    </div>
    <div class="restricted">
      <strong><iron-icon icon="lock"></iron-icon>Restricted</strong>
      Only users with Google permission can see this issue.
    </div>

    <div class="edit-container">
      <chops-button on-click="edit">
        <iron-icon icon="create"></iron-icon>
        Edit feature metadata
      </chops-button>
    </div>

    <chops-dialog id="editMetadata" aria-labelledby="metadataDialogTitle">
      <h3 id="metadataDialogTitle">
        Editing feature details
      </h3>
      <mr-edit-metadata
        id="metadataForm"
        issue="[[issue]]"
        enums="[[enums]]"
        users="[[users]]"
        cc="[[issue.ccRefs]]"
        components="[[issue.componentRefs]]"
        project-name="[[issue.projectName]]"
        urls="[[urls]]"
        statuses="[[statuses]]"
        status="[[issue.statusRef.status]]"
        summary="[[issue.summary]]"
        blocked-on="[[issue.blockedOnIssueRefs]]"
        blocking="[[issue.blockingIssueRefs]]"
        labels="[[issue.labelRefs]]"
      ></mr-edit-metadata>
      <div class="dialog-actions">
        <chops-button on-click="cancel" class="de-emphasized">
          <iron-icon icon="close"></iron-icon>
          Cancel
        </chops-button>
        <chops-button on-click="save" class="emphasized">
          <iron-icon icon="create"></iron-icon>
          Save changes
        </chops-button>
      </div>
    </chops-dialog>
  </template>
  <script src="./mr-metadata.js"></script>
<dom-module>
