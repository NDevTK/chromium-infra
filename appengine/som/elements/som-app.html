<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-page-url/iron-page-url.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../elements/som-alert-card.html">
<link rel="import" href="../elements/som-drawer.html">

<dom-module id="som-app">
  <template>
    <style>
      paper-toolbar {
        --paper-toolbar-background: black;
      }
      .last-updated {
        text-align: right;
        padding-right: 1em;
      }
      #alerts {
        @apply(--layout-vertical);
        @apply(--center-justified);
        margin: 0 auto;
        padding: 8px;
      }
      paper-header-panel[main] {
        --paper-header-panel-body: {
          background: #eee;
        }
      }
      paper-tabs {
        min-width: 500px;
      }
      .title {
        font-size: big;
      }
      .som-title {
        font-weight: bold;
      }
    </style>
    <iron-page-url id="url" path="{{_path}}"></iron-page-url>
    <iron-ajax
        auto
        loading="{{_networkActive}}"
        url="/api/v1/alerts/[[_alertsGroup]]"
        handle-as="json"
        last-response="{{_alertsJson}}"
        debounce-duration="300"></iron-ajax>
    <iron-ajax
        auto
        id="annotations"
        url="/api/v1/annotations"
        handle-as="json"
        last-response="{{annotationsJson}}"
        debounce-duration="300"></iron-ajax>
    <iron-ajax
        id="annotationPost"
        method="post"
        handle-as="json"
        on-response="_postResponse"></iron-ajax>
    <paper-drawer-panel>
      <paper-header-panel drawer>
        <paper-toolbar>
          <span class="som-title">Sheriff-o-Matic</span>
        </paper-toolbar>
        <som-drawer id="drawer" selected-alerts-group="{{_alertsGroup}}"></som-drawer>
      </paper-header-panel>
      <paper-header-panel main>
        <paper-toolbar class="medium-tall">
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <div class="layout horizontal flex">
            <div class="flex title">[[_alertsGroup]]</div>
            <div class="flex last-updated">Last updated: [[_lastUpdated]]</div>
            <iron-icon icon="refresh"></iron-icon>
          </div>
          <paper-spinner active="[[_networkActive]]"></paper-spinner>
          <paper-tabs id="tabs" selected="{{selectedTab}}" attr-for-selected="value" class="bottom self-end">
            <template is="dom-repeat" items="[[_tabs]]" as="tab">
              <paper-tab value="[[tab.id]]">
                <span>[[tab.name]]
                  <paper-badge label="[[tab.count]]"></paper-badge>
                </span>
              </paper-tab>
            </template>
          </paper-tabs>
        </paper-toolbar>
        <div id="alerts" class="layout vertical">
          <template is="dom-repeat" items="[[_alertsJson.alerts]]" as="alert" sort="[[_sort(annotations)]]">
            <som-alert-card
                hidden="[[_filterOut(alert.type, selectedTab)]]"
                alert="[[alert]]"
                annotation="[[_computeAnnotation(annotations,alert)]]"
                on-selected-changed="_handleCardSelected"
                on-annotation-change="_handleAnnotation"
                ></som-alert-card>
          </template>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'som-app',

      attached: function() {
        this._alertsGroup = this.$.url.path.split('/')[1];
      },

      properties: {
        selectedTab: {
          type: String,
          value: 'all',
        },
        _alertsGroup: {
          type: String,
          value: 'chromium',
          observer: '_handleAlertsGroupChange',
        },
        _path: {
          type: String,
          value: '/chromium',
          observer: '_handlePathChange'
        },
        _alertsJson: {
          type: Object,
          value: function() { return {}; }
        },
        // We don't convert the array into an object because the polymer data
        // binding doesn't seem to like mutations to an object, but it's fine
        // watching and notifying about changes to an array :/
        annotations: {
          type: Object,
          computed: '_computeAnnotations(annotationsJson)',
        },
        annotationsJson: Array,
        _lastUpdated: {
          type: Date,
          computed: '_computeLastUpdated(_alertsJson.timestamp)'
        },
        _tabs: {
          type: Array,
          computed: '_tabsFromAlerts(_alertsJson)'
        },
        _networkActive: {
          type: Boolean,
          value: false
        },
      },

      _handleAlertsGroupChange: function(newVal) {
        this._path = '/' + newVal;
      },

      _handlePathChange: function(newVal) {
        this._alertsGroup = newVal.split('/')[1];
      },

      _handleCardSelected: function(e) {
        if (!e.target.selected) {
          return;
        }
        this.selectedCard = e.target;
        let cards = this.querySelectorAll('som-alert-card');
        for (let i = 0; i < cards.length; i++) {
          let card = cards[i];
          if (card != this.selectedCard) {
            card.selected = false;
          }
        }
      },

      _computeLastUpdated: function(lastPosted) {
        if (lastPosted != undefined) {
          return new Date(lastPosted * 1000).toLocaleString();
        }
        return '';
      },

      _sort: function(annotations) {
        return (a, b) => {
          let aAnn = this._computeAnnotation(annotations, a);
          let bAnn = this._computeAnnotation(annotations, b);

          if (aAnn.snoozed == bAnn.snoozed) {
            return 0;
          }

          return aAnn.snoozed ? 1 : -1;
        };
      },

      _computeAnnotations: function(annotationsJson) {
        let annotations = {};
        annotationsJson.forEach(function(annotation) {
          annotations[annotation.key] = annotation;
        });
        return annotations;
      },

      _computeAnnotation: function(annotations, alert) {
        let key = this._keyForAlert(alert);

        let ann = annotations[key];
        return {
          key: key,
          snoozed: ann && ann.snoozeTime ? Date.now() < ann.snoozeTime : false,
        };
      },

      _handleAnnotation: function(evt) {
        let changes = evt.detail.changes;
        let key = this._keyForAlert(evt.model.alert);
        this.$.annotationPost.body = JSON.stringify(changes);
        this.$.annotationPost.url = '/api/v1/annotations/' + key;
        this.$.annotationPost.generateRequest();
      },

      _postResponse: function(evt) {
        let response = evt.detail.response;
        let annotations = this.annotations;
        annotations[response.key] = response;
        let newArray = [];
        Object.keys(annotations).forEach(function(k) {
          newArray.push(annotations[k]);
        });
        this.annotationsJson = newArray;
      },

      _keyForAlert: function(alert) {
        if (alert.extension && alert.extension.reasons &&
            alert.extension.builders) {
          return alert.extension.reasons.map(function(reason) {
            return reason.step;
          }).concat(alert.extension.builders.map(function(builder) {
            return builder.name;
          })).join('::');
        }
        return null;
      },

      _tabsFromAlerts: function(alertsJson) {
        let tabs = [{name: 'All', id: 'all',
            count: !alertsJson.alerts ? 0 : alertsJson.alerts.length || 0}];

        let typeTabs = {};
        if (alertsJson && alertsJson.alerts)  {
          alertsJson.alerts.forEach((alrt) => {
            typeTabs[alrt.type] = (typeTabs[alrt.type] | 0) + 1;
          });

          Object.keys(typeTabs).forEach((k) => {
            tabs.push({name: k, id: k, count: typeTabs[k]});
          });
        }

        return tabs;
      },

      _filterOut: function(alertType, selectedTab) {
        if (selectedTab == 'all') {
          return false;
        }
        if (selectedTab != alertType) {
          return true;
        }
      },
    });
  })();
  </script>
</dom-module>
