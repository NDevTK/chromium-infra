<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="./../../components/expandable-card.html">

<dom-module id="flake-analysis-info">
  <template>
    <style>
      :host {
        display: inline-block;
        width: 100%;
      }

      #header {
        display: inline-block;
        padding-top: 10px;
        padding-bottom: 10px;

        font-size: 16px;
        font-weight: bold;
        text-align: left;

        color: black;
      }

      td {
        padding: 0 10px;
      }

      tr:nth-child(odd) {
        background-color: #f2f2f2;
      }

      ul {
        padding-left: 20px;
        margin-top: 0;
        margin-bottom: 0;
      }

      .title {
        font-size: 16px;
        font-weight: bold;
        color: black;
        text-align: left;
      }

      .description {
        font-weight: 500;
        text-align: right;
        vertical-align: top;
      }

      .data {
        color: darkslategrey;
      }

      .pending {
        background-color: yellow;
      }

      .skipped {
        background-color: gray;
      }

      .completed {
        background-color: green;
      }

      .running {
        background-color: blue;
      }

      .error {
        background-color: red;
      }

    </style>
    <!-- End style. -->
    <expandable-card>
      <div id="header" slot="expandable-card-header" inner-h-t-m-l="[[_header]]"></div>
      <div slot="expandable-card-content">
        <table>
          <tr>
            <td class="description">Regression Range</td>
            <td class="data">
              <template is="dom-if" if="[[shouldShowRegressionRange(status, regressionRangeLower, regressionRangeUpper)]]">
              <span class$="[[status]]">&nbsp;&nbsp;&nbsp;</span>
                <a href$="[[_regressionRangeUrl]]">[[_regressionRangeText]]</a>
                <template is="dom-if" if="[[regressionRangeConfidence]]">
                  (Confidence [[regressionRangeConfidence]]%)
                </template>
              </template>
              <template is="dom-if" if="[[!shouldShowRegressionRange(status, regressionRangeLower, regressionRangeUpper)]]">
              n/a
              </template>
            </td>
          </tr>

          <!-- Show heuristic analysis results. -->
          <template is="dom-if" if="[[hasHeuristicAnalysisResults(heuristicAnalysisResults)]]">
            <tr>
              <td class="description">Heuristic Analysis</td>
              <td class="data">
                <ul>
                  <template is="dom-repeat" items="{{heuristicAnalysisResults}}">
                    <li><a href="{{item.url}}">{{item.commit_position}}</a></li>
                  </template>
                </ul>
              </td>
            </tr>
          </template>

          <!-- Show culprit information. -->
          <template is="dom-if" if="[[isCulpritFound(status, culpritUrl)]]">
            <tr>
              <td class="description">Culprit</td>
              <td class="data">
                <a href$="[[culpritUrl]]">[[culpritText]]</a>
                <template is="dom-if" if="[[culpritConfidence]]">
                  (Confidence [[culpritConfidence]]%)
                </template>
              </td>
            </tr>
          </template>

          <!-- Show bug information and link. -->
          <template is="dom-if" if="[[bugId]]">
            <tr>
              <td class="description">Bug</td>
              <td class="data">
                <a href$="https://crbug.com/[[bugId]]">[[bugId]]</a>
              </td>
            </tr>
          </template>

          <!-- Show error description. -->
          <template is="dom-if" if="[[hasError(status)]]">
            <tr>
              <td class="description">Error</td>
              <td class="data">[[error]]</td>
            </tr>
          </template>
        </table>
      </div>
    </expandable-card>
  </template>

  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'flake-analysis-info',

        properties: {
          status: String,
          regressionRangeConfidence: String,
          regressionRangeUpper: String,
          regressionRangeLower: String,

          heuristicAnalysisResults: Array,

          culpritUrl: String,
          culpritText: String,
          culpritConfidence: String,

          bugId: String,

          error: String,

          _header: {
            type: String,
            computed: 'computeHeader(status, culpritUrl, culpritText, bugId)'
          },

          _regressionRangeUrl: {
            type: String,
            computed: 'computeRegressionRangeUrl(regressionRangeLower, regressionRangeUpper)'
          },

          _regressionRangeText: {
            type: String,
            computed: 'computeRegressionRangeText(regressionRangeLower, regressionRangeUpper)'
          },

        },

        // Computed properties.
        computeHeader: function (status, culpritUrl, culpritText, bugId) {
          var extraInfo = "";
          var result = "";
          status = status.toLowerCase();

          // Regression is finished, but culprit isn't done.
          if (status === "completed") {
            result = "Analysis complete.";
          } else if (status === "pending") {
            result = "Analysis pending.";
          } else if (status === "error"){
            result = "Analysis ended in error.";
          } else {
            result = "Analysis running.";
          }

          // Add extra information
          if (culpritUrl) {
            extraInfo += (" Culprit: <a href='" + culpritUrl + "'>" +
                          culpritText + "</a>. ");
          }

          if (bugId) {
            extraInfo += (" Bug: <a href='https://crbug.com/" + bugId + "'>" +
                          bugId + "</a>. ");
          }

          if (extraInfo) {
            result = result + " " + extraInfo;
          }

          return result;
        },


        computeRegressionRangeUrl: function (regressionRangeLower, regressionRangeUpper) {
          if (!regressionRangeLower || !regressionRangeUpper)
            return 'None';
          return "https://crrev.com/" + regressionRangeLower + ".." + regressionRangeUpper + "?pretty=fuller";
        },

        computeRegressionRangeText: function (regressionRangeLower, regressionRangeUpper) {
          if (!regressionRangeLower || !regressionRangeUpper)
            return 'None';
          return regressionRangeLower +
            '...' +
            regressionRangeUpper;
        },

        // TODO(crbug.com/831675): Show regression range as analysis runs.
        regressionRangeFound: function(regressionRangeLower, regressionRangeUpper) {
          return regressionRangeLower && regressionRangeUpper;
        },

        shouldShowRegressionRange: function(status, regressionRangeLower, regressionRangeUpper) {
          return status.toLowerCase() === 'completed' && this.regressionRangeFound(regressionRangeLower, regressionRangeUpper);
        },

        isCulpritFound: function (status, culpritUrl) {
          return status.toLowerCase() == 'completed' && culpritUrl;
        },

        hasHeuristicAnalysisResults: function(heuristicAnalysisResults) {
          return heuristicAnalysisResults && heuristicAnalysisResults.length > 0;
        },

        hasError: function(status){
          return status.toLowerCase() === 'error';
        },

      });
    })();
  </script>
</dom-module>