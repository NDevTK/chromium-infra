<!-- Copyright (c) 2014 The Chromium Authors. All rights reserved.
     Use of this source code is governed by a BSD-style license that can be
     found in the LICENSE file. -->
<!doctype html>
<html>
  <head>
    <title>Commit Queue Status</title>
    <link href='//fonts.googleapis.com/css?family=RobotoDraft:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en' rel='stylesheet' type='text/css'>
    <script type='text/javascript' src='//www.google.com/jsapi'></script>
    <script>
      var PROJECT = '{{ project|safe }}';
      var LENGTH_DATA = {{ length|safe }};
    </script>
    <style type="text/css">
      body {
        font-family: 'RobotoDraft';
      }
      .chart {
        margin-bottom: 40px;
      }
    </style>
  </head>
  <body>
    <h1>Commit Queue Stats</h1>

    <h2>Times: Single Run</h2>
    <div class="chart" id="attempt-durations"></div>

    <h2>Times: Time in Queue Over All Runs</h2>
    <div class="chart" id="patchset-total-commit-queue-durations"></div>

    <h2>Times: Time from Checking "Commit" Box to Complete</h2>
    <div class="chart" id="patchset-total-wall-time-durations"></div>

    <h2>Commit Queue Length</h2>
    <div class="chart" id="length-chart"></div>

    <script>
      var chartsToDraw = [];
      var drawChart = function() {
        chartsToDraw.push(arguments);
      };
      google.load('visualization', '1.1', {'packages': ['annotationchart']});
      google.setOnLoadCallback(function() {
        drawChart = function(data, id) {
          var dataTable = new google.visualization.DataTable(data);
          // Convert POSIX timestamps to localized Date objects.
          var dataView = new google.visualization.DataView(dataTable);
          var columns = data.cols.map(function(_, i) {return i;});
          columns[0] = {
            label: 'Time',
            type: 'datetime',
            calc: function(table, row) {
              return new Date(table.getValue(row, 0) * 1000);
            },
          };
          dataView.setColumns(columns);
          var chart = new google.visualization.AnnotationChart(
              document.getElementById(id));
          var options = {
            displayAnnotations: true,
          };
          chart.draw(dataView, options);
        };
        chartsToDraw.forEach(function(args) {
          drawChart.apply(null, args);
        });
      });
      drawChart(LENGTH_DATA, 'length-chart');
      loadNamedStats([
        'attempt-durations',
        'patchset-total-commit-queue-durations',
        'patchset-total-wall-time-durations',
      ], function(namedStats) {
        for (var name in namedStats) {
          drawChart(namedStats[name], name);
        }
      });

      function loadNamedStats(names, callback) {
        var namedStats = {};
        names.forEach(function(name) {
          namedStats[name] = {
            cols: [
              {'id': 'timestamp', 'label': 'Time', 'type': 'number'},
              {'id': 'min', 'label': 'Min', 'type': 'number'},
              {'id': 'mean', 'label': 'Mean', 'type': 'number'},
              {'id': 'p50', 'label': '50th', 'type': 'number'},
              {'id': 'p90', 'label': '90th', 'type': 'number'},
              {'id': 'p99', 'label': '99th', 'type': 'number'},
            ],
            rows: [],
          };
        });
        var url = ('//chromium-cq-status.appspot.com/stats/query' +
                   '?project=' + PROJECT +
                   '&interval_minutes=60' +
                   '&names=' + names.join(',') +
                   '&count=25');
        loadJSONResults(url, function(cqStatsList) {
          cqStatsList.forEach(function(cqStats) {
            cqStats.stats.forEach(function(stat) {
              namedStats[stat.name].rows.push({
                c: [
                  {v: cqStats.begin},
                  {v: stat.min / 60},
                  {v: stat.mean / 60},
                  {v: stat.percentile_50 / 60},
                  {v: stat.percentile_90 / 60},
                  {v: stat.percentile_99 / 60},
                ],
              });
            });
          });
          callback(namedStats);
        });
      }
      function loadJSONResults(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('get', url, true);
        xhr.responseType = 'json';
        xhr.onload = function() {
          callback(xhr.response.results);
        };
        xhr.send();
      }
    </script>
  </body>
</html>
