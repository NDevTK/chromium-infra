<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
    <script language="javascript">
      // Split a string in 2 parts. The first is the leading number, if any,
      // the second is the string following the numbers.
      function splitNum(s) {
        var results = new Array();
        results[0] = 'None';
        for (var i = 0; i < s.length; i++) {
          var substr = s.substr(0, i+1)
          if (isNaN(substr)) {
            // Not a number anymore.
            results[1] = s.substr(i)
            break;
          } else {
            // This is a number. update the results.
            results[0] = parseFloat(substr);
          }
        }
        return results;
      }

      // Compare 2 strings using a custom alphanumerical algorithm.
      // This is similar to a normal string sort, except that we sort
      // first by leading digits, if any.
      // For example:
      //  100hello > 2goodbye
      // Numbers anywhere else in the string are compared using the normal
      // sort algorithm.
      function alphanumCompare(a, b) {
        var parsedA = splitNum(a);
        var parsedB = splitNum(b);
        var numA = parsedA[0];
        var numB = parsedB[0];
        var strA = parsedA[1];
        var strB = parsedB[1];

        if (isNaN(numA) == false && isNaN(numB) == false) {
          // They both start with numbers.
          if (numA < numB) return -1;
          if (numA > numB) return 1;
          // Identical. Fallback to string.
          return (strA < strB) ? -1 : (strA > strB ? 1 : 0)
        }

        // If only one starts with a number, we start with that one as
        // the lowest.
        if (isNaN(numA) == false) return -1
        if (isNaN(numB) == false) return 1

        // They are both strings.
        return (a < b) ? -1 : (a > b ? 1 : 0)
      }
    </script>
  </head>
  <body>
    <script type="application/javascript">
      String.prototype.startsWith = function(str) {
        return (this.match('^' + str) == str)
      }

      // Helper function to retrieve the value of a GET query parameter.
      // Greatly inspired from http://alturl.com/8rj7a
      function getParameter(parameterName) {
        // Add '=' to the parameter name (i.e. parameterName=value)
        var parameterName = parameterName + '=';
        var queryString = window.location.search.substring(1);
        if (queryString.length <= 0) {
          return '';
        }

        // Find the beginning of the string
        begin = queryString.indexOf(parameterName);

        // If the parameter name is not found, skip it, otherwise return the
        // value.
        if (begin == -1) {
          return '';
        }

        // Add the length (integer) to the beginning.
        begin += parameterName.length;

        // Multiple parameters are separated by the '&' sign.
        end = queryString.indexOf ('&', begin);

        if (end == -1) {
          end = queryString.length;
        }

        // Return the string.
        return escape(unescape(queryString.substring(begin, end)));
      }

      function getDisplayName(objectName, prefix) {
        if(objectName.indexOf(prefix) == 0) {
          return objectName.substring(prefix.length);
        }
        return objectName;
      }

      var CR_GIT_COMMIT_KEY = 'Cr-Git-Commit';

      function getCommitHTML(bucket, storageObject) {
        var gitCommit = (storageObject.metadata || {})[CR_GIT_COMMIT_KEY];

        // Handle no metadata
        if (gitCommit === undefined) {
          return '-';
        }

        return '<a href="https://crrev.com/' + escape(gitCommit) + '">' +
               gitCommit + '</a>';
      }

      // Displays the directory listing given the XML and prefix.
      function displayList(objectDict, bucket, root, prefix) {
        // Display the header
        document.write('<h1>Index of <em>' + bucket + '</em>: /' +
                       prefix + '</h1>');

        // Start the table for the results.
        document.write('<table style="border-spacing:15px 0px;">');

        var sortOrder = getParameter('sort');
        var sortLink = location.pathname + '?prefix=' + escape(prefix);
        if (sortOrder != 'desc') {
          sortLink += '&sort=desc';
        }

        // Display the table header.
        document.write('<tr><th><img src="' + root +
                       '/icons/blank.gif" alt="[ICO]"></th>');
        document.write('<th><a href="' + sortLink + '">Name</a></th>');
        document.write('<th>Last modified</th>');
        document.write('<th>Size</th>');
        document.write('<th>Commit</th></tr>');
        document.write('<tr><th colspan="5"><hr></th></tr>');

        // Display the 'go back' button.
        if (prefix != '') {
          var backpath = location.pathname;

          // If there is more than one section delimited by '/' in the current
          // prefix we truncate the last section and append the rest to
          // backpath.
          var delimiter = prefix.lastIndexOf('/');
          if (delimiter >= 0) {
            delimiter = prefix.substr(0, delimiter).lastIndexOf('/');
            if (delimiter >= 0) {
              backpath += '?prefix=';
              backpath += escape(prefix.substr(0, delimiter+1));
            }
          }

          document.write('<tr><td valign="top"><img src="' + root +
                         '/icons/back.gif" alt="[DIR]"></td>');
          document.write('<td><a href="');
          document.write(backpath);
          document.write('">Parent Directory</a></td>');
          document.write('<td>&nbsp;</td>');
          document.write('<td align="right">  - </td></tr>');
        }

        // Identify directories
        var directories = (objectDict.prefixes || [])
        directories.sort(alphanumCompare);

        // Set up the variables.
        var files = Array();
        (objectDict.items || []).forEach(function(storageObject) {
          // If this object _is_ the current prefix, skip it.
          if(
              (storageObject.kind !== 'storage#object') ||
              (storageObject.name === prefix)) {
            return;
          }
          files.push(storageObject);
        });
        files.sort(function(a, b){
            return alphanumCompare(a.name, b.name);
        });

        // Reverse the list for a descending sort.
        if (sortOrder == 'desc') {
          files.reverse();
          directories.reverse();
        }

        // Display the directories.
        directories.forEach(function(directory) {
          var lnk = location.pathname.substr(0, location.pathname.indexOf('?'));
          lnk += '?prefix=' + directory;

          document.write('<tr>');
          document.write('<td valign="top"><img src="' + root +
                         '/icons/folder.gif" alt="[DIR]"></td>');
          document.write('<td><a href="' + lnk + '">' +
                         getDisplayName(directory, prefix) + '</a></td>');
          document.write('<td align="right">-</td>');
          document.write('<td align="right">-</td>');
          document.write('<td align="right">-</td>');
          document.write('</tr>');
        });

        // Display the files.
        files.forEach(function(storageObject) {
          var link = storageObject['mediaLink'];
          var filename = getDisplayName(storageObject['name'], prefix);
          var size = parseInt(storageObject['size']) / 1024 / 1024;
          var lastModified = storageObject['updated'].replace('T', ' ');
          lastModified = lastModified.substr(0, lastModified.indexOf('.'));

          // Remove the entries we don't want to show.
          if (filename == '') {
            return;
          }

          // Display the row.
          document.write('<tr>');
          document.write('<td valign="top"><img src="' + root +
                         '/icons/binary.gif" alt="[DIR]"></td>');
          document.write('<td><a href="' + link + '">' + filename +
                         '</a></td>');
          document.write('<td align="right">' + lastModified + '</td>');
          document.write('<td align="right">' + size.toFixed(2) + 'MB</td>');
          document.write('<td align="right">' +
                         getCommitHTML(bucket, storageObject) + '</td>')
          document.write('</tr>');
        });

        // Close the table.
        document.write('<tr><th colspan="5"><hr></th></tr>');
        document.write('</table>');
      }

      function fetchAndDisplay() {
        var prefix = getParameter('prefix');
        var lastSlash = location.pathname.lastIndexOf("/");
        var root = location.pathname.substring(0, lastSlash);
        var bucket = root;
        if(bucket[0] == "/") {
          bucket = bucket.substring(1);
        }

        var gsAPIBase = 'https://www.googleapis.com/storage/v1';
        var fieldsParam = 'items(kind,mediaLink,metadata,name,size,updated),' +
                          'kind,prefixes';
        var gsAPIListObjects = gsAPIBase + '/b/' + bucket + '/o';
        var url = gsAPIListObjects + '?delimiter=/&prefix=' + prefix +
                  '&fields=' + fieldsParam;

        var http = new XMLHttpRequest();
        http.open('GET', url, true);
        http.onreadystatechange = useHttpResponse;
        http.send(null);
        function useHttpResponse() {
          if (http.readyState === http.DONE) {
            objectsDict = JSON.parse(http.responseText);
            if(objectsDict['kind'] != 'storage#objects') {
              console.log("JSON API did not return 'storage#objects' object");
            } else {
              displayList(objectsDict, bucket, root, unescape(prefix));
            }
          }
        }
      }

      fetchAndDisplay('');
    </script>
  </body>
</html>
