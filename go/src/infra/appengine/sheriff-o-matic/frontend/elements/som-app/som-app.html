<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../../elements/som-header-styles.html">

<link rel="import" href="../../elements/som-alert-view/som-alert-view.html">
<link rel="import" href="../../elements/som-drawer/som-drawer.html">

<link rel="import" href="../../elements/som-test-expectations/som-test-expectations.html">

<link rel="import" href="../../elements/pages/som-help.html">
<link rel="import" href="../../elements/pages/som-rotation-calendar.html">

<script src="../../bower_components/moment/min/moment.min.js"></script>
<script src="../../bower_components/moment-timezone/builds/moment-timezone-with-data.min.js"></script>
<dom-module id="som-app">
  <template>
    <style include="som-header-styles"></style>
    <style>
      iron-pages {
        @apply(--layout-vertical);
        min-height: 100%;
      }
      paper-toolbar {
        --paper-toolbar-background: black;
      }
      paper-toolbar a {
        color: #fff;
      }
      paper-header-panel[main] {
        --paper-header-panel-body: {
          background: #eee;
        }
      }
      span.line {
        display: inline-block;
      }
      #alertView {
        padding-bottom: 5em;
      }
      #refresh {
        display: flex;
        width: 25px;
        height: 25px;
        padding: 0 2px;
        cursor: pointer;
      }
      .error {
        color: #c00;
        margin-top: 0;
      }
      .last-updated {
        min-width: 200px;
      }
      .last-updated, .user-name {
        text-align: right;
        padding-right: 1em;
      }
      .last-updated {
        min-width: 200px;
      }
      .last-updated, .user-name {
        text-align: right;
        padding-right: 1em;
      }
      .page-body {
        @apply(--layout-vertical);
        align-items: stretch;
        justify-content: flex-start;
        background: white;
        border-left: 1px solid #ddd;
        padding: 1em 16px;
        min-height: 100%;
        flex-grow: 1;
      }
      .som-title {
        font-weight: bold;
      }
      .som-title img {
        max-width: 30px;
        max-height: 30px;
        vertical-align: middle;
      }
      .title {
        font-size: big;
      }
      @media (max-width: 1024px) {
        .last-updated, .user-name {
          padding-right: 0.5em;
          font-size: 0.9em;
          line-height: 100%;
        }
        .user-name {
          @apply(--layout-flex);
        }
      }
      @media (max-width: 540px) {
        .last-updated, .user-name {
          font-size: 0.8em;
          min-width: 10%;
          text-align: left;
        }
        #fetchingAlerts {
          display: none;
        }
        #tree-title {
          display: none;
        }
      }
      #testExpectations {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        min-height: 100%;
      }
    </style>
    <iron-location id="url" path="{{_path}}" url-space-regex="^(?!(/_ah/|/auth/))"></iron-location>
    <paper-drawer-panel responsive-width="1024px">
      <paper-header-panel drawer>
        <paper-toolbar>
          <span class="som-title">
            <template is="dom-if" if="[[_treeLogo]]">
              <a href="/[[_tree.name]]"><img src="[[_treeLogo]]" alt="[[_tree.name]]" title="[[_tree.name]]" /></a>
            </template>
            Sheriff-o-Matic
          </span>
        </paper-toolbar>
        <som-drawer
            id="drawer"
            path="{{_path}}"
            static-pages="[[_staticPages]]"
            show-infra-failures="{{showInfraFailures}}"
            link-style="{{linkStyle}}"
            tree="[[_tree]]"
            trees="{{_trees}}"
            collapse-by-default="{{collapseByDefault}}"
            ></som-drawer>
      </paper-header-panel>
      <paper-header-panel main id="mainHeaderPanel">
        <paper-toolbar>
          <div class="layout horizontal flex">
            <iron-icon icon="menu" paper-drawer-toggle></iron-icon>
            <div class="flex title" id="tree-title">[[_pathIdentifier]]</div>
            <div class="flex last-updated">
              Last updated: <span hidden$="[[!_lastUpdated]]" id="lastUpdatedTime">
                <span class="line">[[_lastUpdated.time]]</span>
                <span class="line">([[_lastUpdated.relativeTime]])</span>
              </span>
              <span hidden$="[[_lastUpdated]]" id="lastUpdatedUnknown">Unknown</span>
            </div>
            <div class="horizontal user-name">
              [[user]] (<a href$="[[logoutUrl]]">Log Out </a>)
            </div>
            <iron-icon id="refresh" on-tap="_refresh" icon="refresh"></iron-icon>
          </div>
          <paper-spinner id="fetchingAlerts" active="[[_fetchingAlerts]]"></paper-spinner>
        </paper-toolbar>
        <iron-pages attr-for-selected='id' selected="[[_selectedPage]]">
          <template is="dom-if" if="[[_showAlertView]]">
            <som-alert-view id="alertView" class="page-body"
              alerts-times="{{alertsTimes}}"
              examined-alert-key="[[_examinedAlertKey]]"
              fetching-alerts="{{_fetchingAlerts}}"
              trees="[[_trees]]"
              tree="[[_tree]]"
              user="[[user]]"
              link-style="[[linkStyle]]"
              show-infra-failures="[[showInfraFailures]]"
              collapse-by-default="[[collapseByDefault]]"
              xsrf-token="[[xsrfToken]]"></som-alert-view>
          </template>
          <som-help id="helpSOM" class="page-body"></som-help>
          <template is="dom-if" if="[[_showRotationCalendar]]">
            <som-rotation-calendar id="rotationCalendar" class="page-body"></som-rotation-calendar>
          </template>
          <template is="dom-if" if="[[_showTestExpectations]]">
            <som-test-expectations class="page-body" id="testExpectations"></som-test-expectations>
          </template>
        </iron-pages>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  <script src="som-app.js"></script>
</dom-module>
