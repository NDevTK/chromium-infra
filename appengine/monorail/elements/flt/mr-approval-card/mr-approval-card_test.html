<meta charset="utf-8">
<script src="/bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>
<link rel="import" href="/elements/flt/mr-approval-card/mr-approval-card.html">
<test-fixture id="basic">
  <template>
    <mr-approval-card></mr-approval-card>
  </template>
</test-fixture>
<script>
(function() {
  'use strict';

  suite('basic tests', function() {
    var element;

    setup(function() {
      element = fixture('basic');
    });

    test('renders', function(done) {
      flush(() => {
        assert.isDefined(element, 'element is defined');
        done();
      });
    });

    test('_isApprovalOwner true when user is an approver', function() {
      const userNotInList = element._computeIsApprovalOwner([
        {displayName: 'tester@user.com'},
        {displayName: 'test@notuser.com'},
        {displayName: 'hello@world.com'},
      ], 'test@user.com', []);
      assert.isFalse(userNotInList);

      const userInList = element._computeIsApprovalOwner([
        {displayName: 'tester@user.com'},
        {displayName: 'test@notuser.com'},
        {displayName: 'hello@world.com'},
        {displayName: 'test@user.com'},
      ], 'test@user.com', []);
      assert.isTrue(userInList);

      const userGroupNotInList = element._computeIsApprovalOwner([
        {displayName: 'tester@user.com'},
        {displayName: 'nongroup@group.com'},
        {displayName: 'group@nongroup.com'},
        {displayName: 'ignore@test.com'},
      ], 'test@user.com', [
        {displayName: 'group@group.com'},
        {displayName: 'test@group.com'},
        {displayName: 'group@user.com'},
      ]);
      assert.isFalse(userGroupNotInList);

      const userGroupInList = element._computeIsApprovalOwner([
        {displayName: 'tester@user.com'},
        {displayName: 'group@group.com'},
        {displayName: 'test@notuser.com'},
      ], 'test@user.com', [
        {displayName: 'group@group.com'},
      ]);
      assert.isTrue(userGroupInList);
    });

    test('site admins have approver privileges', function(done) {
      const notice = element.shadowRoot.querySelector('.approver-notice');
      assert.equal(notice.textContent.trim(), '');

      element.user = {isSiteAdmin: true};
      assert.isTrue(element._hasApproverPrivileges);

      flush(() => {
        assert.equal(notice.textContent.trim(),
          'Your site admin privileges give you full access to edit this approval.'
        );
        done();
      });
    });

    test('_updateSurveyHandler fired when mr-inline-editor saved', function(done) {
      element._updateSurveyHandler = sinon.stub();

      const editor = element.shadowRoot.querySelector('mr-inline-editor');

      editor.sendEmail = true;
      editor.setContent('blah');
      editor.save();

      flush(() => {
        const calledWithEvt = element._updateSurveyHandler.args[0][0];
        assert.deepEqual(calledWithEvt.detail, {
          commentContent: 'blah',
          sendEmail: true,
        });
        assert.isTrue(element._updateSurveyHandler.calledOnce);
        done();
      });
    });
  });
})();
</script>
