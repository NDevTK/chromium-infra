<meta charset="utf-8">
<script src="/bower_components/web-component-tester/browser.js"></script>

<script type="module">
import ClientLogger from '../../static/js/monitoring/client-logger.js';
import MonorailTSMon from '../../static/js/monitoring/ts-mon.js';

suite('ClientLogger', () => {

  setup(() => {
    window.CS_env = {
      token: 'rutabaga-token',
      tokenExpiresSec: 1234,
    };
    window.chops = {rpc: {PrpcClient: sinon.spy()}};
    MonorailTSMon.prototype.disableAfterNextFlush = sinon.spy();
  });

  suite('constructor', function() {
    test('assigns this.category', function() {
      const c = new ClientLogger('rutabaga');
      assert.equal(c.category, 'rutabaga');
    });

    test('gets started events from sessionStorage', function() {
      const startedEvents = {
        event1: {
          time: 12345678,
          labels: ['label1', 'label2'],
        },
        event2: {
          time: 87654321,
          labels: ['label2'],
        },
      };
      const key = 'ClientLogger.rutabaga.started';
      sessionStorage[key] = JSON.stringify(startedEvents);

      const c = new ClientLogger('rutabaga');
      assert.deepEqual(startedEvents, c.startedEvents);
    });
  });

  test('records ts_mon metrics', function() {
    window.ga = sinon.spy();
    const c = new ClientLogger('issues');
    const issueCreateMetric = c.tsMon._userTimingMetrics[0].metric;
    issueCreateMetric.add = sinon.spy();
    const issueUpdateMetric = c.tsMon._userTimingMetrics[1].metric;
    issueUpdateMetric.add = sinon.spy();

    c.logStart('rutabaga');
    c.logEnd('rutabaga');
    sinon.assert.notCalled(issueCreateMetric.add);
    sinon.assert.notCalled(issueUpdateMetric.add);
    issueCreateMetric.add.reset();
    issueUpdateMetric.add.reset();

    c.logStart('new-issue');
    c.logEnd('new-issue');
    sinon.assert.calledOnce(issueCreateMetric.add);
    sinon.assert.notCalled(issueUpdateMetric.add);
    issueCreateMetric.add.reset();
    issueUpdateMetric.add.reset();

    c.logStart('issue-update');
    c.logEnd('issue-update');
    sinon.assert.notCalled(issueCreateMetric.add);
    sinon.assert.calledOnce(issueUpdateMetric.add);
  });

});
</script>
