<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="ct-commit.html">
<link rel="import" href="ct-detailed-commit.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="ct-user-prefs.html">

<polymer-element name="ct-commit-list" attributes="flex commitList detailed suspectedCLGroup">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-icon-button {
        vertical-align: middle;
      }
      paper-icon-button::shadow #icon {
        margin: 0px;
      }
      .repository-info {
        display: block;
        margin-bottom: 10px;
      }
      ct-commit {
        margin-left: 10px;
      }
      .first {
        margin-top: -4px;
      }
      .notfirst {
        border-top: 1px solid lightgrey;
        margin-top: 3px;
      }
      .findit-result {
        color: red;
      }
    </style>
    <ct-user-prefs id="userPrefs"></ct-user-prefs>
    <template if="{{ totalSuspects_ > 0 || totalCulprits_ > 0 }}">
      <div id="findit-result"><span class="findit-result">{{ _finditResult() }}</span> <a target="{{ $.userPrefs.values.linkTarget }}" href="https://findit-for-me.appspot.com/waterfall/build-failure?url={{ representiveBuildUrl_ }}">(Details)</a></div>
    </template>
    <template repeat="{{ repository in commitList.repositories }}">
      <div class="repository-info">
        <span style="font-weight: bold">{{ repository.name }}</span>
        <template if="{{ repository.name == 'chromium' }}">
          <a target="{{ $.userPrefs.values.linkTarget }}" href="http://test-results.appspot.com/revision_range?start={{ repository.firstRevision }}&end={{ repository.lastRevision }}">{{ repository.range }}</a>
        </template>
        <template if="{{ repository.name == 'blink' }}">
          <a target="{{ $.userPrefs.values.linkTarget }}" href="http://build.chromium.org/f/chromium/perf/dashboard/ui/changelog_blink.html?url=/trunk&range={{ repository.firstRevision }}:{{ repository.lastRevision }}&mode=html">{{ repository.range }}</a>
        </template>
        <template if="{{ repository.name != 'blink' && repository.name != 'chromium'}}">{{ repository.range }}</template>
        <paper-icon-button icon="unfold-more"
            on-click="{{ _toggle }}" repository="{{ repository.name }}"></paper-icon-button>
        <template if="{{ repository.expanded }}">
          <template repeat="{{ commit, commit_index in repository.commits }}">
            <template if="{{ !detailed }}">
              <ct-commit class="{{ commit_index == 0 ? 'first' : 'notfirst' }}" data="{{ commit }}" highlight="{{ commit.revision | _shouldHighlightCommit(repository.name) }}"></ct-commit>
            </template>
            <template if="{{ detailed }}">
              <ct-detailed-commit class="{{ commit_index == 0 ? 'first' : 'notfirst' }}" data="{{ commit }}" highlight="{{ commit.revision | _shouldHighlightCommit(repository.name) }}"></ct-detailed-commit>
            </template>
          </template>
        </template>
      </div>
    </template>
  </template>
  <script>
  Polymer({
    detailed: false,
    commitsByRepo_: {},
    totalSuspects_: 0,
    totalCulprits_: 0,
    representiveBuildUrl_: null,

    observe: {
      commitList: '_updateSuspectedCommitInfo',
      suspectedCLGroup: '_updateSuspectedCommitInfo',
    },

    _toggle: function(event, detail, sender, target) {
      var repo = sender.getAttribute('repository');
      var r = this.commitList.repositories.find(function(item) {
        return item.name === repo;
      });
      r.expanded = !r.expanded;

      var anyExpanded = this.commitList.repositories.some(function(item) {
        return item.expanded;
      });

      if (anyExpanded) {
        this.setAttribute('flex', r.expanded);
      } else {
        this.removeAttribute('flex');
      }
    },

    _updateSuspectedCommitInfo: function() {
      this.commitsByRepo_ = {};
      this.totalSuspects_ = 0;
      this.totalCulprits_ = 0;
      this.representiveBuildUrl_ = null;

      if (Object.isEmpty(this.suspectedCLGroup))
        return;

      this.representiveBuildUrl_ = this.suspectedCLGroup.buildUrl;
      var suspectedCLsByRepo = this.suspectedCLGroup.suspectedCLsByRepo;

      this.commitList.repositories.forEach(function(repository) {
        if (!suspectedCLsByRepo[repository.name])
          return;

        repository.commits.forEach(function(commit) {
          var suspectedCL = null;

          // If a suspected CL is not in the regression range, don't show it on UI.
          Object.keys(suspectedCLsByRepo[repository.name], function(revision, cl) {
            // In builder_alerts and sheriff-o-matic, git commit position is referred as revision.
            if (cl.commitPosition == commit.revision) {
              suspectedCL = cl;
            }
          }.bind(this));

          if (suspectedCL) {
            if (!this.commitsByRepo_[repository.name]) {
              this.commitsByRepo_[repository.name] = {};
            }
            this.commitsByRepo_[repository.name][commit.revision] = suspectedCL;

            if (suspectedCL.foundByTryJob > 0) {
              // Try-job result is more reliable than heuristic.
              this.totalCulprits_ += 1;
            } else {  // suspectedCL.foundByHeuristic > 0
              this.totalSuspects_ += 1;
            }
          }
        }.bind(this));
      }.bind(this));
    },

    _getSingleCL: function() {
      // There is only one culprit or suspect.
      var cl = '';
      Object.keys(this.commitsByRepo_, function(repoName, revisions) {
        Object.keys(revisions, function(revision, clInfo) {
          cl = repoName + ':' + revision;
        }.bind(this));
      }.bind(this));
      return cl;
    },

    _finditResult: function() {
      // For 90% of failures, Findit will identify only one culprit or suspect.
      if (this.totalCulprits_ == 1)
        return 'Findit Try-Job found culprit ' + this._getSingleCL();
      else if (this.totalCulprits_ > 1)
        return 'Findit Try-Job found ' + this.totalCulprits_ + ' culprits';
      else if (this.totalSuspects_ == 1)
        return 'Findit Heuristic found suspect ' + this._getSingleCL();
      else if (this.totalSuspects_ > 1)
        return 'Findit Heuristic found ' + this.totalSuspects_ + ' suspects';
      return 'Findit found nothing';  // Should never be reached.
    },

    _shouldHighlightCommit: function(revision, repoName) {
      return this.commitsByRepo_[repoName] && this.commitsByRepo_[repoName][revision] && this.commitsByRepo_[repoName][revision] !== undefined;
    },
  });
  </script>
</polymer-element>
