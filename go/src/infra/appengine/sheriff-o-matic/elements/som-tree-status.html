<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../elements/som-formatted-text.html">

<dom-module id="som-tree-status">
  <template>
    <style>
    #error,
    #treeClosed {
      box-sizing: border-box;
      width: 100%;
      padding: 8px 10px;
      margin: 5px auto;
      border: 1px solid #dcdcdc;
      color: #fff;
      background-color: #E75D54;
      border-radius: 5px;
    }
    a, a:visited,
    som-formatted-text /deep/ a, som-formatted-text /deep/ a:visited {
      color: #fff;
    }
    </style>
    <iron-ajax
      id="treeStatus"
      url="[[_statusUrl]]/current?format=json"
      handle-as="json"
      last-error="{{_statusErrorJson}}"
      last-response="{{_statusJson}}"
      debounce-duration="300"></iron-ajax>
    <div id="error" hidden$="[[!_hasError]]">
      Error fetching tree status from <a href="[[_statusUrl]]" target="_blank">[[_statusUrl]]</a>
    </div>
    <div id="treeClosed" hidden$="[[_hideNotice]]">
      <som-formatted-text text="[[_message]]"></som-formatted-text>
      by <a href="mailto:[[_email]]">[[_username]]</a> on [[_time]] (<a href="[[_statusUrl]]" target="_blank">More</a>)
    </div>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'som-tree-status',

      properties: {
        tree: {
          type: String,
          observer: 'refresh',
        },
        _hasError: {
          type: Boolean,
          computed: '_computeHasError(_hasStatusApp, _statusErrorJson)',
          value: false,
        },
        _hasStatusApp: {
          type: Boolean,
          computed: '_computeHasStatusApp(tree, _statusApps)',
        },
        _hideNotice: {
          type: Boolean,
          computed: '_computeHideNotice(_hasStatusApp, _isClosed, _hasError)',
          value: true,
        },
        _statusApps: {
          type: Object,
          value: {
            'chromium': 'https://chromium-status.appspot.com',
            'chromiumos': 'https://chromiumos-status.appspot.com',
            'trooper': 'https://infra-status.appspot.com/',
          },
        },
        _statusErrorJson: Object,
        _statusJson: Object,
        _statusUrl: {
          type: String,
          computed: '_computeStatusUrl(tree, _statusApps)',
        },
        // Processed JSON data
        _email: {
          type: String,
          computed: '_computeEmail(_statusJson)',
        },
        _isClosed: {
          type: Boolean,
          value: false,
          computed: '_computeIsClosed(_statusJson)',
        },
        _message: {
          type: String,
          computed: '_computeMessage(_statusJson)',
        },
        _time: {
          type: String,
          computed: '_computeTime(_statusJson)',
        },
        _username: {
          type: String,
          computed: '_computeUsername(_email)',
        },
      },

      refresh: function() {
        if (!this._hasStatusApp) {
          return;
        }
        this.$.treeStatus.generateRequest();
      },

      _computeHasError: function(hasStatusApp, json) {
        return hasStatusApp && !!json && Object.keys(json).length > 0;
      },

      _computeHasStatusApp: function(tree, statusApps) {
        return tree in statusApps;
      },

      _computeHideNotice: function(hasStatusApp, isClosed, hasError) {
        return !hasStatusApp || !isClosed || hasError;
      },

      _computeStatusUrl: function(tree, statusApps) {
        if (!this._hasStatusApp) {
          return '';
        }

        return statusApps[tree];
      },

      // Processing JSON data for display
      _computeEmail(json) {
        if (!json || !json.username) {
          return '';
        }
        return json.username;
      },

      _computeIsClosed(json) {
        if (!json || !json.general_state) {
          return false;
        }
        return json.general_state === 'closed';
      },

      _computeMessage(json) {
        if (!json || !json.message) {
          return 'Unknown';
        }
        return json.message;
      },

      _computeTime(json) {
        if (!json || !json.date) {
          return 'Unknown';
        }
        return json.date + " GMT";
      },

      _computeUsername(email) {
        let cutoff = email.indexOf("@");
        if (cutoff < 0) {
          return 'Unknown';
        }
        return email.substring(0, cutoff);
      },
    });
  })();
  </script>
</dom-module>
