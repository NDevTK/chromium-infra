<!DOCTYPE html>
<title>Autolink Test</title>
<meta charset="utf-8">
<script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>

<script src="/static/js/autolink.js"></script>
<script>
  'use strict';
  const components = window.__autolink.Components;
  const createIssueRefRun = window.__autolink.createIssueRefRun;
  suite('crbug component functions', function() {
      const {lookup, extractRefs, reStrs, replacer} = components.get('01-tracker-crbug');

      test('Extract crbug project and local ids', function() {
          let match = reStrs[0].exec('https://crbug.com/monorail/1234');
          reStrs[0].lastIndex = 0;
          let ref = extractRefs(match);
          assert.deepEqual(ref, {projectName: 'monorail', localId: '1234'});
      });

      test('Replace crbug with found components', function() {
          const str = 'crbug.com/monorail/1234';
          const match = reStrs[0].exec(str);
          reStrs[0].lastIndex = 0;
          const components = {closedRefs: [{localId: 1234, projectName: 'monorail'}, {}]};
          const actualRun = replacer(match, components);
          assert.deepEqual(
              actualRun,
              {
                  tag: 'a',
                  css: 'strikeThrough',
                  href:'/p/monorail/issues/detail?id=1234',
                  content: str
              }
          );
      });

      test('Replace crbug with default project_name', function() {
          const str = 'crbug.com/1234';
          const match = reStrs[0].exec(str);
          reStrs[0].lastIndex = 0;
          const components = {openRefs: [{localId: 134}, {localId: 1234, projectName: 'chromium'}]};
          const actualRun = replacer(match, components);
          assert.deepEqual(
              actualRun,
              {
                  tag: 'a',
                  href:'/p/chromium/issues/detail?id=1234',
                  css:'',
                  content: str
              }
          );
      });

      test('Replace crbug with no found components', function() {
          const str = 'crbug.com/1234';
          const match = reStrs[0].exec(str);
          reStrs[0].lastIndex = 0;
          const components = {};
          const actualRun = replacer(match, components);
          assert.deepEqual(actualRun, {content: str});
      });
  });

  suite('regular tracker component functions', function() {
      const {lookup, extractRefs, reStrs, replacer} = components.get('02-tracker-regular');
      const str = 'bugs=123, monorail:234 or #345 and PROJ:#456';
      const match = reStrs[0].exec(str);
      reStrs[0].lastIndex = 0;

      test('Extract tracker projects and local ids', function() {
          const actualRefs = extractRefs(match);
          assert.deepEqual(
              actualRefs,
              [{projectName: 'chromium', localId: '123'},
               {projectName: 'monorail', localId: '234'},
               {projectName: 'monorail', localId: '345'},
               {projectName: 'PROJ', localId: '456'}]);
      });

      test('Replace tracker refs.', function() {
          const components = {
              openRefs: [
                  {projectName: 'monorail', localId: 888},
                  {projectName: 'chromium', localId: '123'},
              ],
              closedRefs: [
                  {projectName: 'proj', localId: 456},
              ]
          };
          const actualTextRuns = replacer(match, components);
          assert.deepEqual(
              actualTextRuns,
              [
                  {
                      tag: 'a',
                      href:'/p/chromium/issues/detail?id=123',
                      css: '',
                      content: '123',
                  },
                  {content: 'monorail:234'},
                  {content: '#345'},
                  {
                      tag: 'a',
                      href:'/p/PROJ/issues/detail?id=456',
                      css: 'strikeThrough',
                      content: 'PROJ:#456',
                  },
              ]
          );
      });
  });

  suite('user email component functions', function() {
      const {lookup, extractRefs, reStrs, replacer} = components.get('03-user-emails');
      const str = 'We should ask User1@gmail.com to confirm.';
      const match = reStrs[0].exec(str);
      reStrs[0].lastIndex = 0;

      test('Extract user email', function() {
          const actualEmail = extractRefs(match, 'unusedProjectName');
          assert.equal('User1@gmail.com', actualEmail);
      });

      test('Replace existing user.', function() {
          const components = {
              users: [{email: 'user2@gmail.com'}, {email: 'user1@gmail.com'}]};
          const actualTextRun = replacer(match, components);
          assert.deepEqual(
              actualTextRun,
              {tag: 'a', href: '/u/User1@gmail.com', content: 'User1@gmail.com'}
          );
      });

      test('Replace non-existent user.', function() {
          const actualTextRun = replacer(match, {});
          assert.deepEqual(
              actualTextRun,
              {
                  tag: 'a',
                  href: 'mailto:User1@gmail.com',
                  content: 'User1@gmail.com',
              }
          );
      });

  });

  suite('url component functions.', function() {
      const {lookup, extracRefs, reStrs, replacer} = components.get('04-urls');

      test('test short link regex string', function() {
          const shortLinkRE = reStrs[0];
          const str = 'go/shortlinks ./_go/shortlinks bo/short bo/1234  https://who/shortlinks go/hey/?wct=(go)';
          let match;
          let actualMatches = [];
          while ((match = shortLinkRE.exec(str)) !== null) {
              actualMatches.push(match[0]);
          }
          assert.deepEqual(
              actualMatches, ['go/shortlinks', 'https://who/shortlinks', 'go/hey/?wct=(go)']);
      });

      test('test numeric short linke regex string', function() {
          const shortNumLinkRE = reStrs[1];
          const str = 'go/nono omg/ohno omg/123 .cl/123 b/1234'
          let match;
          let actualMatches = [];
          while ((match = shortNumLinkRE.exec(str)) !== null) {
              actualMatches.push(match[0]);
          }
          assert.deepEqual(
              actualMatches, ['omg/123', 'b/1234']);
      });

      test('test implied link regex string', function() {
          const impliedLinkRE = reStrs[2];
          const str = 'incomplete.com .help.com hey.net/other="(blah)"';
          let match;
          let actualMatches = [];
          while ((match = impliedLinkRE.exec(str)) !== null) {
              actualMatches.push(match[0]);
          }
          assert.deepEqual(
              actualMatches, ['incomplete.com', 'hey.net/other="(blah)"']);
      });

      test('test full link regex string', function() {
          const isLinkRE = reStrs[3];
          const str = 'https://www.go.com nospacehttps://www.blah.com http://website.net/other="(}])"><)'
          let match;
          let actualMatches = [];
          while ((match = isLinkRE.exec(str)) !== null) {
              actualMatches.push(match[0]);
          }
          assert.deepEqual(
              actualMatches, ['https://www.go.com', 'http://website.net/other="(}])">']);
      });

      test('Replace URL plain text', function() {
          const match = reStrs[2].exec('link here: (website.net/other="here").');
          reStrs[2].lastIndex = 0;
          const actualTextRuns = replacer(match);
          console.log(JSON.stringify(actualTextRuns));
          assert.deepEqual(
              actualTextRuns,
              [{tag: 'a',
                href: 'https://website.net/other="here"',
                content: 'website.net/other="here"',
               },
               {content: ').'}]
          );
      });
  });
</script>
