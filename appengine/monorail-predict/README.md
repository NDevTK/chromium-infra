# Monorail Prediction Service

The Monorail prediction service is a separate appengine module running in a
Managed VM with a custom runtime.  We have to run it this way because it depends
on libraries (sklearn, e.g.) that do not come with the standard AppEngine
runtime, nor with the
[```python```](https://cloud.google.com/appengine/docs/flexible/python/) runtime
that comes with [AppEngine Flexible
Environment](https://cloud.google.com/appengine/docs/flexible/). Hence the
docker file.

On startup, the service will load some prediction model files from GCS and
un-pickle them (these files are generated by some internal batch jobs beyond the
scope of this doc TODO: write a doc for these and link to it). This loading and
processing takes some time, during which /_ah/health will return a 503 "Service
Unfavailable" response code.  Once the loading is complete it will return 200
ok.

The API is very simple, and for now only provides suggestions for Issue
Components based on text entered by the user: ```POST``` to ```/_predict``` a
JSON object of the form: ```
{'text': 'text to classify'}
```
and it will return a JSON object of the form:
```
{'components': ['Component1', 'Component2', 'etc']}
```

There is an additional resource for logging accept actions: ```GET``` to
```/_log``` and any parameters are stored in GAE's request logs for the
```predict``` service. The JS client will request it whenever the user accepts
one of the component suggestions. We should add more detailed logging for
accept/reject actions in the future, but this should give us a rough
approximation of the accept rate for the time being.

## Development

To run locally, from this directory:
```
gunicorn -b :5000 service:app
```
Use port 5000 so it doesn't conflict with your regular monorail devserver
running on 8080.

You may need to install several python packages locally before you can run this
service. See the Dockerfile for details on what it expects to be installed
already. If you are brave and have docker installed already, try runing it with
docker instead!

## Deployment
To deploy, from this directory:

```
gcloud app deploy app.yaml --project=monorail-predict
```

The service itself is exposed on staging as
[monorail-predict.appspot.com](https://monorail-predict.appspot.com/)

### Debugging Deployment Issues
If you run into problems (deployment fails, saying the instance may be
"unhealthy", e.g.), check the ```stderr``` and ```stdout``` logs for the
```predict``` service on devconsole.  There may be a missing dependency that you
have locally but isn't included in the Dockerfile.


