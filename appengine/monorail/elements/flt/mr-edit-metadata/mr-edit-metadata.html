<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../redux/redux-mixin.html">
<link rel="import" href="../../redux/selectors.html">
<link rel="import" href="./mr-edit-field.html">

<dom-module id="mr-edit-metadata">
  <template>
    <style>
      :host {
        display: block;
        --mr-edit-field-styles: {
          box-sizing: border-box;
          width: 100%;
          padding: 0.25em 4px;
        }
      }
      select,
      input {
        @apply --mr-edit-field-styles;
      }
      label {
        font-weight: bold;
        word-wrap: break-word;
        text-align: right;
      }
      textarea {
        width: 100%;
        margin: 0.5em 0;
        box-sizing: border-box;
        border: 1px solid hsl(0, 0%, 70%);
        height: 8em;
        transition: height 0.1s ease-in-out;
        padding: 0.5em 4px;
        grid-column-start: 1;
        grid-column-end: 2;
      }
      textarea:placeholder-shown {
        height: 5em;
      }
      textarea:focus {
        height: 8em;
      }
      button.toggle {
        background: none;
        color: hsl(240, 100%, 40%);
        border: 0;
        width: 100%;
        padding: 0.25em 0;
        text-align: left;
      }
      button.toggle:hover {
        cursor: pointer;
        text-decoration: underline;
      }
      .input-grid {
        padding: 0.5em 0;
        display: grid;
        max-width: 100%;
        grid-gap: 8px;
        grid-template-columns: 120px auto;
        align-items: flex-start;
      }
      @media (max-width: 600px) {
        label {
          margin-top: 8px;
          text-align: left;
        }
        .input-grid {
          grid-gap: 4px;
          grid-template-columns: 100%;
        }
      }
    </style>
    <form id="editForm">
      <div class="input-grid">
        <template is="dom-if" if="[[!isApproval]]">
          <label for="summaryInput">Summary:</label>
          <input id="summaryInput" value$="[[summary]]" />
        </template>
        <label for="statusInput">Status:</label>

        <select id="statusInput">
          <template is="dom-repeat" items="[[statuses]]">
            <option
              value$="[[item.status]]"
              selected$="[[_computeIsSelected(status, item.status)]]"
            >
              [[item.status]]
              <template is="dom-if" if="[[item.docstring]]">
                - [[item.docstring]]
              </template>
            </option>
          </template>
        </select>


        <template is="dom-if" if="[[!isApproval]]">
          <label for="ownerInput" on-click="_clickLabelForCustomInput">Owner:</label>
          <mr-edit-field
            id="ownerInput"
            type="USER_TYPE"
            initial-values="[[_wrapList(ownerName)]]"
          ></mr-edit-field>

          <label for="ccInput" on-click="_clickLabelForCustomInput">CC:</label>
          <mr-edit-field
            id="ccInput"
            type="USER_TYPE"
            initial-values="[[_mapUserRefsToNames(cc)]]"
            multi
          ></mr-edit-field>

          <label for="componentsInput" on-click="_clickLabelForCustomInput">Components:</label>
          <mr-edit-field
            id="componentsInput"
            type="STR_TYPE"
            initial-values="[[_mapComponentRefsToNames(components)]]"
            multi
          ></mr-edit-field>
        </template>

        <template is="dom-if" if="[[_and(isApprover, isApproval)]]">
          <label for="approversInput" on-click="_clickLabelForCustomInput">Approvers:</label>
          <mr-edit-field
            id="approversInput"
            type="USER_TYPE"
            initial-values="[[_mapUserRefsToNames(approvers)]]"
            multi
          ></mr-edit-field>
        </template>

        <template is="dom-repeat" items="[[fieldDefs]]" as="field">
          <label
            hidden$="[[_fieldIsHidden(showNicheFields, field.isNiche)]]"
            for$="[[_idForField(field.fieldRef.fieldName)]]"
            on-click="_clickLabelForCustomInput"
            title$="[[field.docstring]]"
          >
            [[field.fieldRef.fieldName]]:
          </label>
          <mr-edit-field
            hidden$="[[_fieldIsHidden(showNicheFields, field.isNiche)]]"
            id$="[[_idForField(field.fieldRef.fieldName)]]"
            name="[[field.fieldRef.fieldName]]"
            type="[[field.fieldRef.type]]"
            options="[[_optionsForField(projectConfig.labelDefs, field.fieldRef.fieldName)]]"
            initial-values="[[_valuesForField(_fieldValueMap, field.fieldRef.fieldName)]]"
            multi="[[field.isMultivalued]]"
          ></mr-edit-field>
        </template>

        <template is="dom-if" if="[[!isApproval]]">
          <label for="blockedOnInput" on-click="_clickLabelForCustomInput">Blocked on:</label>
          <mr-edit-field
            id="blockedOnInput"
            initial-values="[[_mapBlockerRefsToIdStrings(blockedOn, projectName)]]"
            multi
          ></mr-edit-field>

          <label for="blockingInput" on-click="_clickLabelForCustomInput">Blocking:</label>
          <mr-edit-field
            id="blockingInput"
            initial-values="[[_mapBlockerRefsToIdStrings(blocking, projectName)]]"
            multi
          ></mr-edit-field>

          <label for="labelsInput" on-click="_clickLabelForCustomInput">Labels:</label>
          <mr-edit-field
            id="labelsInput"
            initial-values="[[labelNames]]"
            multi
          ></mr-edit-field>
        </template>

        <span></span>
        <button type="button" class="toggle" on-click="toggleNicheFields" hidden$="[[!_nicheFieldCount]]">
          <span hidden$="[[showNicheFields]]">
            Show all fields ([[_nicheFieldCount]] currently hidden)
          </span>
          <span hidden$="[[!showNicheFields]]">
            Hide niche fields ([[_nicheFieldCount]] currently shown)
          </span>
        </button>
      </div>
      <textarea id="commentText" placeholder="Comment to explain this change"></textarea>
    </form>
  </template>
  <script src="./mr-edit-metadata.js"></script>
<dom-module>
