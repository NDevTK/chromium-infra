<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/chopsui/chops-dialog.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../../redux/selectors.html">
<link rel="import" href="../../redux/redux-mixin.html">
<link rel="import" href="../../shared/field-types.html">
<link rel="import" href="../../mr-comment-content/mr-comment-content.html">
<link rel="import" href="../mr-comments/mr-comments.html">
<link rel="import" href="../mr-inline-editor/mr-inline-editor.html">
<link rel="import" href="../mr-edit-metadata/mr-edit-metadata.html">
<link rel="import" href="../mr-metadata/mr-metadata.html">
<link rel="import" href="../shared/mr-flt-styles.html">

<dom-module id="mr-approval-card">
  <template>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
    <style include="mr-flt-styles">
      :host {
        width: 100%;
        background-color: white;
        font-size: 85%;
        border-bottom: 1px solid hsl(0, 0%, 85%);
        box-sizing: border-box;
        display: block;
        border-left: 4px solid var(--approval-bg-color);
        --approval-bg-color: hsl(227, 20%, 92%);
        --approval-accent-color: hsl(227, 80%, 40%);
      }
      :host(.status-approved) {
        --approval-bg-color: hsl(78, 55%, 90%);
        --approval-accent-color: hsl(78, 100%, 30%);
      }
      :host(.status-pending) {
        --approval-bg-color: hsl(40, 75%, 90%);
        --approval-accent-color: hsl(33, 100%, 39%);
      }
      :host(.status-rejected) {
        --approval-bg-color: hsl(5, 60%, 92%);
        --approval-accent-color: hsl(357, 100%, 39%);
      }
      h3 {
        margin: 0;
        padding: 0;
        display: inline;
        font-weight: inherit;
        font-size: inherit;
        line-height: inherit;
      }
      mr-inline-editor {
        display: block;
        width: 100%;
        margin-bottom: 0.5em;
        color: hsl(0, 0%, 30%);
        box-sizing: border-box;
        word-wrap: break-word;
        --mr-inline-editor-textarea-min-height: 300px;
      }
      .approver-notice {
        padding: 0.25em 0;
        width: 100%;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        border-bottom: 1px dotted hsl(0, 0%, 83%);
      }
      .card-content {
        box-sizing: border-box;
        padding: 0.5em 16px;
        padding-bottom: 1em;
      }
      .expand-icon {
        display: block;
        margin-right: 8px;
        color: hsl(0, 0%, 45%);
      }
      .header {
        margin: 0;
        width: 100%;
        border: 0;
        font-size: 120%;
        font-weight: normal;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        flex-direction: row;
        padding: 0.5em 8px;
        background-color: var(--approval-bg-color);
        cursor: pointer;
      }
      .status {
        font-size: 80%;
        color: var(--approval-accent-color);
        display: inline-flex;
        align-items: center;
        margin-left: 32px;
      }
      .survey {
        padding: 0.5em 0;
        max-height: 500px;
        overflow-y: auto;
        max-width: 100%;
        box-sizing: border-box;
      }
    </style>
    <button class="header" on-click="toggleCard" aria-expanded$="[[_toString(opened)]]">
      <i class="material-icons expand-icon">[[_expandIcon]]</i>
      <h3>[[fieldName]]</h3>
      <span class="status">
        <i class="material-icons status-icon">[[_statusIcon]]</i>
        [[_status]]
      </span>
    </button>
    <iron-collapse class="card-content" id="cardCollapse" opened="[[opened]]">
      <div class="approver-notice">
        <template is="dom-if" if="[[_isApprovalOwner]]">
          You are an approver for this bit.
        </template>
        <template is="dom-if" if="[[user.isSiteAdmin]]">
          Your site admin privileges give you full access to edit this approval.
        </template>
      </div>
      <mr-metadata
        aria-label$="[[fieldName]] Approval Metadata"
        approval-status="[[_status]]"
        approvers="[[approvers]]"
        setter="[[setter]]"
        field-defs="[[fieldDefs]]"
        is-approval="true"
      ></mr-metadata>
      <mr-inline-editor
        heading-level=4
        content="[[_survey.content]]"
        title$="[[fieldName]] Survey"
        edit-text="Edit responses"
        placeholder="Survey content and answer"
        on-save="_updateSurveyHandler"
      >
        <div class="survey">
          <mr-comment-content content="[[_survey.content]]"></mr-comment-content>
        </div>
      </mr-inline-editor>
      <h4 class="medium-heading">Approval comments / Changelog</h3>
      <mr-comments
        heading-level=5
        comments="[[_comments]]"
      >
        <h4 id$="[[_editId]]" class="medium-heading">
          Editing approval: [[phaseName]] &gt; [[fieldName]]
        </h4>
        <mr-edit-metadata
          id="metadataForm"
          approvers="[[approvers]]"
          field-defs="[[fieldDefs]]"
          statuses="[[_availableStatuses]]"
          status="[[_status]]"
          has-approver-privileges="[[_hasApproverPrivileges]]"
          is-approval
          disabled="[[updatingApproval]]"
          error="[[updateApprovalError.description]]"
          on-save="save"
          on-discard="reset"
        ></mr-edit-metadata>
      </mr-comments>
    </iron-collapse>
  </template>
  <script src="./mr-approval-card.js"></script>
<dom-module>
