<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/chopsui/chops-dialog.html">
<link rel="import" href="../../../bower_components/chopsui/chops-timestamp.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../mr-bug-link/mr-bug-link.html">
<link rel="import" href="../../mr-user-link/mr-user-link.html">
<link rel="import" href="../shared/metadata-mixin.html">
<link rel="import" href="../shared/mr-flt-styles.html">
<link rel="import" href="../mr-metadata/mr-field-values.html">
<link rel="import" href="./mr-issue-table.html">
<link rel="import" href="./mr-update-issue-hotlists.html">

<dom-module id="mr-metadata">
  <template>
    <style include="mr-flt-styles">
      :host {
        display: table;
        table-layout: fixed;
        width: 100%;
      }
      td, th {
        padding: 0.5em 4px;
        vertical-align: top;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      td {
        width: 60%;
      }
      th {
        text-align: left;
        width: 40%;
      }
      .group-separator {
        border-top: 1px solid hsl(120, 15%, 85%);
      }
      .group-title {
        font-weight: normal;
        font-style: oblique;
        border-bottom: 1px solid hsl(120, 15%, 85%);
        text-align: center;
      }
    </style>
    <template is="dom-if" if="[[approvalStatus]]">
      <tr>
        <th>Status:</th>
        <td>
          [[approvalStatus]]
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[approvers.length]]">
      <tr>
        <th>Approvers:</th>
        <td>
          <template is="dom-repeat" items="[[approvers]]">
            <mr-user-link
              display-name="[[item.displayName]]"
              user-id="[[item.userId]]"
            ></mr-user-link><br />
          </template>
        </td>
      </tr>
    </template>
    <template is="dom-if" if="[[setter]]">
      <th>Setter:</th>
      <td>
        <mr-user-link
          display-name="[[setter.displayName]]"
          user-id="[[setter.userId]]"
        ></mr-user-link>
      </td>
    </template>

    <template is="dom-if" if="[[owner]]">
      <tr>
        <th>Owner:</th>
        <td>
          <mr-user-link
            display-name="[[owner.displayName]]"
            user-id="[[owner.userId]]"
          ></mr-user-link>
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[cc.length]]">
      <tr>
        <th>CC:</th>
        <td>
          <template is="dom-repeat" items="[[cc]]">
            <mr-user-link
              display-name="[[item.displayName]]"
              user-id="[[item.userId]]"
            ></mr-user-link><br />
          </template>
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[issueStatus]]">
      <tr>
        <th>Status:</th>
        <td>
          [[issueStatus.status]]
          <em hidden$="[[!issueStatus.meansOpen]]">
            (Open)
          </em>
          <em hidden$="[[issueStatus.meansOpen]]">
            (Closed)
          </em>
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[components.length]]">
      <tr>
        <th>Components:</th>
        <td>
          <template is="dom-repeat" items="[[components]]">
            <a href$="/p/[[projectName]]/issues/list?q=component:[[item.path]]"
              title$="[[item.path]] = [[item.docstring]]"
            >
              [[item.path]]
            </a>
          </template>
        </td>
      </tr>
    </template>

    <template is="dom-repeat" items="[[_fieldDefsWithGroups]]" as="group">
      <tr>
        <th class="group-title" colspan="2">
          [[group.groupName]]
        </th>
      </tr>
      <template is="dom-repeat" items="[[group.fieldDefs]]" as="field">
        <tr hidden$="[[_fieldIsHidden(_fieldValueMap, field)]]">
          <th title$="[[field.fieldRef.fieldName]]">[[field.fieldRef.fieldName]]:</th>
          <td>
            <mr-field-values
              name="[[field.fieldRef.fieldName]]"
              type="[[field.fieldRef.type]]"
              values="[[_valuesForField(_fieldValueMap, field.fieldRef.fieldName, phaseName)]]"
              project-name="[[projectName]]"
            ></mr-field-values>
          </td>
        </tr>
      </template>
      <tr>
        <th class="group-separator" colspan="2"></th>
      </tr>
    </template>

    <template is="dom-repeat" items="[[_fieldDefsWithoutGroup]]" as="field">
      <tr hidden$="[[_fieldIsHidden(_fieldValueMap, field)]]">
        <th title$="[[field.fieldRef.fieldName]]">[[field.fieldRef.fieldName]]:</th>
        <td>
          <mr-field-values
            name="[[field.fieldRef.fieldName]]"
            type="[[field.fieldRef.type]]"
            values="[[_valuesForField(_fieldValueMap, field.fieldRef.fieldName)]]"
            project-name="[[projectName]]"
          ></mr-field-values>
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[sortedBlockedOn]]">
      <tr>
        <th>BlockedOn:</th>
        <td>
          <template is="dom-repeat" items="[[sortedBlockedOn]]">
            <mr-bug-link
              project-name="[[projectName]]"
              issue="[[_getIssueForRef(blockerReferences, item)]]"
              is-closed$="[[_getIsClosedForRef(blockerReferences, item)]]"
            >
            </mr-bug-link>
            <br />
          </template>
          <chops-button
            on-click="openViewBlockedOn">
            <iron-icon icon="view-list"></iron-icon>
            &nbsp;View details
          </chops-button>
        </td>
      </tr>
    </template>
    <chops-dialog id="viewBlockedOnDialog">
      <mr-issue-table
        id="viewBlockedOnTable"
        columns="[[blockedOnTableColumns]]"
        rows="[[blockedOnTableRows]]"
        on-reorder="reorderBlockedOn"
        rerank-enabled="[[blockedOnIssuesRerankEnabled]]"
      >
      </mr-issue-table>
    </chops-dialog>

    <template is="dom-if" if="[[blocking]]">
      <tr>
        <th>Blocking:</th>
        <td>
          <template is="dom-repeat" items="[[blocking]]">
            <mr-bug-link
              project-name="[[projectName]]"
              issue="[[_getIssueForRef(blockerReferences, item)]]"
              is-closed$="[[_getIsClosedForRef(blockerReferences, item)]]"
            >
            </mr-bug-link>
            <br />
          </template>
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[modifiedTimestamp]]">
      <tr>
        <th>Modified:</th>
        <td>
          <chops-timestamp timestamp="[[modifiedTimestamp]]" short></chops-timestamp>
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[user]]">
      <tr>
        <th>
          Your Hotlists:
        </th>
        <td>
          <template is="dom-if" if="[[hotlistsByRole.user.length]]">
            <template is="dom-repeat" items="[[hotlistsByRole.user]]">
              <a href$="/u/[[item.ownerRef.userId]]/hotlists/[[item.name]]"
                title$="[[item.name]] - [[item.summary]]">
                [[item.name]]
              </a>
              <br />
            </template>
          </template>
          <chops-button
            on-click="openUpdateHotlists">
            <iron-icon icon="create"></iron-icon>
            &nbsp;Edit your hotlists.
          </chops-button>
        </td>
      </tr>
    </template>
    <chops-dialog id="updateHotlistsDialog">
      <mr-update-issue-hotlists
        id="updateHotlistsForm"
        on-discard="closeUpdateHotlists"
        on-save="saveUpdateHotlists"
      >
      </mr-update-issue-hotlists>
    </chops-dialog>

    <template is="dom-if" if="[[hotlistsByRole.participants.length]]">
      <tr>
        <th>Participant's Hotlists:</th>
        <td>
          <template is="dom-repeat" items="[[hotlistsByRole.participants]]">
            <a href$="/u/[[item.ownerRef.userId]]/hotlists/[[item.name]]"
              title$="[[item.name]] - [[item.summary]]">
              [[item.name]]
            </a>
            <br />
          </template>
        </td>
      </tr>
    </template>

    <template is="dom-if" if="[[hotlistsByRole.others.length]]">
      <tr>
        <th>Other Hotlists:</th>
        <td>
          <template is="dom-repeat" items="[[hotlistsByRole.others]]">
            <a href$="/u/[[item.ownerRef.userId]]/hotlists/[[item.name]]"
              title$="[[item.name]] - [[item.summary]]">
              [[item.name]]
            </a>
            <br />
          </template>
        </td>
      </tr>
    </template>
  </template>
  <script src="./mr-metadata.js"></script>
<dom-module>
