<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/chopsui/chops-dialog.html">

<link rel="import" href="../../redux/selectors.html">
<link rel="import" href="../../redux/redux-mixin.html">
<link rel="import" href="../mr-approval-card/mr-approval-card.html">
<link rel="import" href="../mr-edit-metadata/mr-edit-metadata.html">
<link rel="import" href="../mr-metadata/mr-field-values.html">
<link rel="import" href="../shared/metadata-mixin.html">
<link rel="import" href="../shared/mr-flt-styles.html">

<dom-module id="mr-phase">
  <template>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
    <style include="mr-flt-styles">
      :host {
        display: block;
      }
      chops-dialog {
        font-size: 85%;
        --chops-dialog-theme: {
          width: 500px;
          max-width: 100%;
        };
      }
      h2 {
        margin: 0;
        font-size: 105%;
        font-weight: normal;
        padding: 0.5em 8px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        flex-direction: row;
        justify-content: space-between;
      }
      h2 em {
        margin-left: 16px;
        font-size: 80%;
      }
      .phase-edit {
        padding: 0.1em 8px;
      }
    </style>
    <h2>
      <span>
        Approvals<span hidden$="[[_isEmpty(phaseName)]]">:
          [[phaseName]]
        </span>
        <span hidden$="[[!_setPhaseFields.length]]">
          -
          <template is="dom-repeat" items="[[_setPhaseFields]]" as="field">
            [[field.fieldRef.fieldName]]
            <mr-field-values
              name="[[field.fieldRef.fieldName]]"
              type="[[field.fieldRef.type]]"
              values="[[_valuesForField(fieldValueMap, field.fieldRef.fieldName, phaseName)]]"
              project-name="[[projectName]]"
            ></mr-field-values><span hidden$="[[_isLastItem(_setPhaseFields.length, index)]]">;
          </template>
          <em hidden$="[[!_nextDate]]">
            [[_dateDescriptor]]
            <chops-timestamp timestamp="[[_nextDate]]"></chops-timestamp>
          </em>
        </span>
      </span>
      <chops-button hidden$="[[_isEmpty(phaseName)]]" on-click="edit" class="de-emphasized phase-edit">
        <i class="material-icons">create</i>
        Edit
      </chops-button>
    </h2>
    <template is="dom-repeat" items="[[approvals]]">
      <mr-approval-card
          approvers="[[item.approverRefs]]"
          setter="[[item.setterRef]]"
          field-name="[[item.fieldRef.fieldName]]"
          phase-name="[[phaseName]]"
          status-enum="[[item.status]]"
          survey="[[item.survey]]"
          survey-template="[[item.surveyTemplate]]"
          urls="[[item.urls]]"
          labels="[[item.labels]]"
          users="[[item.users]]"
      ></mr-approval-card>
    </template>
    <template is="dom-if" if="[[!approvals.length]]">
      No tasks for this phase.
    </template>
    <chops-dialog id="editPhase" aria-labelledby="phaseDialogTitle">
      <h3 id="phaseDialogTitle" class="medium-heading">
        Editing phase: [[phaseName]]
      </h3>
      <mr-edit-metadata
        id="metadataForm"
        field-defs="[[fieldDefs]]"
        field-values="[[fieldValues]]"
        phase-name="[[phaseName]]"
        disabled="[[updatingIssue]]"
        error="[[updateIssueError.description]]"
        on-save="save"
        on-discard="cancel"
        is-approval
        disable-attachments
      ></mr-edit-metadata>
    </chops-dialog>
  </template>
  <script src="./mr-phase.js"></script>
<dom-module>
