<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/elements/som-extension-build-failure.html">

<dom-module id="som-alert-item">
  <template>
    <style>
      .alert {
        @apply(--layout-horizontal);
        padding: 1em;
        background-color: white;
        border: 1px solid #ddd;
        cursor: pointer;
      }
      .alert-expanded {
        color: #666;
      }
     .alert-title-bar {
       display: flex;
       justify-content: space-between;
       align-items: center;
     }
     .alert-title {
       font-weight: bold;
       font-size: larger;
     }
     .alert-times {
       font-size: smaller;
       color: #666;
     }
     .alert-links {
       display: inline-block;
     }
     .list-item {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .file-bug,
      .snooze {
        color: #aaa;
      }
      .snoozed {
        opacity: 0.5;
      }
      #root {
        transition: opacity .25s;
      }
    </style>
    <div id="root" class$="[[_cssClass]]">
      <div class$="[[_classForAlert(alert, selected)]]">
        <div class="list-item">
          <div class="alert-title-bar">
            <div class="alert-title">[[alert.title]]</div>
            <div class="alert-times">
              [[_duration]]
            </div>
          </div>
          <div class="alert-body">[[alert.body]]</div>
          <div class="alert-expanded">
            <paper-button>
              <a href$="[[alertsGroup]]/examine/[[alert.key]]">Examine</a>
            </paper-button>
            <div id="noBugs" hidden$="[[_hasBugs]]" class="alert-links">
              No Linked Bugs.
            </div>
            <div id="bugsList" hidden$="[[!_hasBugs]]" class="alert-links">
              Bugs:
              <template is="dom-repeat" items="[[annotation.bugs]]" as="bug">
                <paper-button><iron-icon icon="open-in-new"></iron-icon>
                  <a target="_blank" href$="[[bug]]">[[_bugLabel(bug)]]</a>
                </paper-button>
                <paper-icon-button id="remove[[index]]" icon="close" on-tap="_removeBug">
                </paper-icon-button>
              </template>
            </div>
            <som-extension-build-failure extension="[[alert.extension]]"></som-extension-build-failure>
          </div>
        </div>
        <paper-icon-button on-tap="_fileBug" class="file-bug" icon="bug-report" alt="File a bug"></paper-icon-button>
        <paper-icon-button id="snooze" class="snooze" icon="[[_snoozeIcon]]" title$="[[_snoozeText]]" on-tap="_snooze"></paper-icon-button>
      </div>
    </div>
  </template>
  <script>
  (function() {
    'use strict';

    const bugLinkRegExp = /([0-9]{3,})/;


    Polymer({
      is: 'som-alert-item',

      /**
       * Fired when an alert requests that the link bug dialog be shown.
       *
       * @event link-bug
       */

      /**
       * Fired when an alert has an annotation change that needs to be sent to the
       * server.
       *
       * @event annotation-change
       * @param {Object} changes The changes to be sent to the server.
       */

      properties: {
        alert: Object,
        alertsGroup: String, 
        annotation: Object,
        _cssClass: {
          type: String,
          computed: '_computeCssClass(annotation.snoozed)',
        },
        _duration: {
          type: String,
          computed: '_calculateDuration(alert)'
        },
        _hasBugs: {
          type: Boolean,
          computed: '_computeHasBugs(annotation.bugs)',
        },
        _latestTime: {
          type: String,
          computed: '_formatTimestamp(alert.time)'
        },
        _snoozeText: {
          type: String,
          computed: '_computeSnoozeText(annotation.snoozed)',
        },
        _snoozeIcon: {
          type: String,
          computed: '_computeSnoozeIcon(annotation.snoozed)',
        },
        _startTime: {
          type: String,
          computed: '_formatTimestamp(alert.start_time)'
        },
      },

      _bugLabel: function(bugUrl) {
        let bugId = bugLinkRegExp.exec(bugUrl);

        return `Bug ${bugId[0]}`;
      },

      _classForAlert: function(alert, selected) {
        return 'alert' + (selected ? ' selected' : '');
      },

      _computeHasBugs: function(bugs) {
        return !!(bugs && bugs.length > 0);
      },

      _computeSnoozeText: function(snoozed) {
        return snoozed ? 'Unsnooze' : 'Snooze';
      },

      _computeCssClass: function(snoozed) {
        return snoozed ? 'snoozed' : '';
      },

      _computeSnoozeIcon: function(snoozed) {
        return snoozed ? 'alarm-off' : 'alarm';
      },

      _fileBug: function(evt) {
        this.fire('link-bug');
      },

      _formatTimestamp: function(timestamp) {
        if (timestamp != undefined) {
          return new Date(timestamp * 1000).toLocaleString();
        }
        return '';
      },

      _calculateDuration(alert) {
        let deltaSec = Math.round((alert.time - alert.start_time));
        let hours = Math.floor(deltaSec/60/60);
        let minutes = Math.floor((deltaSec - hours*60*60)/60);
        let seconds = deltaSec - hours * 60*60 - minutes*60;
        return `${hours}h ${minutes}m ${seconds}s`;
      },

      _removeBug: function(evt) {
        this.fire('annotation-change', {
          changes: [{
            'remove': {'bugs': [evt.model.bug]},
          }]
        });
      },

      _snooze: function(evt) {
        if (this.annotation.snoozed) {
          this.fire('annotation-change', {
            changes: [{
              'remove': {'snoozeTime': true},
            }]
          });
        } else {
          this.fire('annotation-change', {
            changes: [{
              'add': {
                snoozeTime: Date.now() + 1000 * 60 * 60 * 60 * 60,
              }
            }]
          });
        }
      },
    });
  })();
  </script>
</dom-module>
