<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="./../../components/expandable-card.html">

<dom-module id="flake-analysis-info">
  <template>
    <style>
      :host {
        display: inline-block;
        width: 100%;
      }

      #header {
        display: inline-block;
        padding-top: 10px;
        padding-bottom: 10px;

        font-size: 16px;
        font-weight: bold;
        text-align: left;

        color: black;
      }

      td {
        padding: 0 10px;
      }

      tr:nth-child(odd) {
        background-color: #f2f2f2;
      }

      ul {
        padding-left: 20px;
        margin-top: 0;
        margin-bottom: 0;
      }

      .title {
        font-size: 16px;
        font-weight: bold;
        color: black;
        text-align: left;
      }

      .description {
        font-weight: 500;
        text-align: right;
        vertical-align: top;
      }

      .data {
        color: darkslategrey;
      }

      .pending {
        color: #666666;
        background-color: #fffc6c;
        border-color: #c5c56d;
      }

      .completed {
        color: #ffffff;
        background-color: #8fdf5f;
        border-color: #4f8530;
      }

      .running {
        color: #666666;
        background-color: #fffc6c;
        border-color: #c5c56d;
      }

      .error {
        color: #ffffff;
        background-color: #e98080;
        border-color: #a77272;
      }

    </style>
    <!-- End style. -->
    <expandable-card show-more>
      <div id="header" slot="expandable-card-header" inner-h-t-m-l="[[_header]]"></div>
      <div slot="expandable-card-content">
        <table>
          <template is="dom-if" if="[[! culpritRevision]]">
            <!--Show regression range if no culprit is found yet.-->
            <tr>
              <td class="description">Regression Range</td>
              <td class="data">
                <span class$="[[status]]">&nbsp;&nbsp;&nbsp;</span>
                <template is="dom-if" if="[[regressionRangeFound(regressionRangeLower, regressionRangeUpper)]]">
                  <a href$="https://crrev.com/[[regressionRangeLower]]..[[regressionRangeUpper]]?pretty=fuller">[[regressionRangeLower]]..[[regressionRangeUpper]]</a>
                </template>
                <template is="dom-if" if="[[onlyUpperBoundFound(regressionRangeLower, regressionRangeUpper)]]">
                  ?..[[regressionRangeUpper]]
                </template>
                <template is="dom-if" if="[[flakeIsNotReproducible(regressionRangeLower, regressionRangeUpper)]]">
                  unreproducible
                </template>
              </td>
            </tr>
          </template>

          <!-- Show heuristic analysis results. -->
          <template is="dom-if" if="[[hasHeuristicAnalysisResults(heuristicAnalysisResults)]]">
            <tr>
              <td class="description">Heuristic Analysis</td>
              <td class="data">
                  <template is="dom-repeat" items="{{heuristicAnalysisResults}}">
                    <a href="{{item.url}}">{{item.commit_position}}</a>&nbsp;
                  </template>
              </td>
            </tr>
          </template>

          <!-- Show culprit information. -->
          <template is="dom-if" if="[[culpritUrl]]">
            <tr>
              <td class="description">Culprit</td>
              <td class="data">
                <a href$="[[culpritUrl]]">[[culpritRevision]]</a>
                <template is="dom-if" if="[[culpritConfidence]]">
                  (Confidence [[culpritConfidence]]%)
                </template>
              </td>
            </tr>
          </template>

          <!-- Show bug information and link. -->
          <template is="dom-if" if="[[bugId]]">
            <tr>
              <td class="description">Bug</td>
              <td class="data">
                <a href$="https://crbug.com/[[bugId]]">[[bugId]]</a>
              </td>
            </tr>
          </template>

          <!-- Show error description. -->
          <template is="dom-if" if="[[hasError(status)]]">
            <tr>
              <td class="description">Error</td>
              <td class="data">[[error]]</td>
            </tr>
          </template>
        </table>
      </div>
    </expandable-card>
  </template>

  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'flake-analysis-info',

        properties: {
          status: String,
          regressionRangeUpper: String,
          regressionRangeLower: String,

          heuristicAnalysisResults: Array,

          culpritUrl: String,
          culpritRevision: String,
          culpritConfidence: String,

          bugId: String,

          error: String,

          _header: {
            type: String,
            computed: 'computeHeader(status, culpritUrl, culpritRevision, bugId)'
          },

        },

        // Computed properties.
        computeHeader: function (status, culpritUrl, culpritRevision, bugId) {
          var extraInfo = "";
          var result = "";
          status = status.toLowerCase();

          // Regression is finished, but culprit isn't done.
          if (status === "completed") {
            result = "Analysis completed.";
          } else if (status === "pending") {
            result = "Analysis pending.";
          } else if (status === "error"){
            result = "Analysis errored.";
          } else {
            result = "Analysis running.";
          }

          // Add extra information
          if (culpritUrl) {
            extraInfo += (" Culprit: <a href='" + culpritUrl + "'>" +
                          culpritRevision + "</a>. ");
          }

          if (this.flakeIsNotReproducible(this.regressionRangeLower, this.regressionRangeUpper)) {
            extraInfo += "Unreproducible."
          }

          if (bugId) {
            extraInfo += (" Bug: <a href='https://crbug.com/" + bugId + "'>" +
                          bugId + "</a>. ");
          }

          if (extraInfo) {
            result = result + " " + extraInfo;
          }

          return result;
        },

        regressionRangeFound: function(regressionRangeLower, regressionRangeUpper) {
          return regressionRangeLower && regressionRangeUpper;
        },

        onlyUpperBoundFound: function(regressionRangeLower, regressionRangeUpper) {
          return !regressionRangeLower && regressionRangeUpper;
        },

        flakeIsNotReproducible: function(regressionRangeLower, regressionRangeUpper) {
          return regressionRangeLower && !regressionRangeUpper;
        },

        hasHeuristicAnalysisResults: function(heuristicAnalysisResults) {
          return heuristicAnalysisResults && heuristicAnalysisResults.length > 0;
        },

        hasError: function(status){
          return status.toLowerCase() === 'error';
        },

      });
    })();
  </script>
</dom-module>
