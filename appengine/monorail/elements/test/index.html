<meta charset="utf-8">
<base href="/">
<script src="/bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>
<style>
  body {
    font-family: sans-serif;
  }
</style>
<script>
  var testFiles = [];
  [
    'elements/mr-approval-page/mr-approval-page-test.html',
  ].forEach((file) => {
    testFiles.push(`/${file}`);
    testFiles.push(`/${file}?dom=shadow`);
  });

  // BEGIN WCT MONKEYPATCH
  //
  // The following two functions are sort of a hack to work around WCT's
  // current lack of event listening hooks for things like "test finished" and
  // "suite finished". They exist in order to report test results back to
  // the go app that spawned the browser process that runs these tests.
  // See https://github.com/Polymer/web-component-tester/issues/271 for
  // more context.
  let end = function() {
    let passes = WCT._reporter.stats.passes;
    let failures = WCT._reporter.stats.failures;
    fetch('/done', {
        method: 'POST',
        body: JSON.stringify({
            'passes': passes,
            'failures': failures,
            // TODO(seanmccullough): Report timeouts, other exceptions?
        }),
    }).then(function(resp) {
      window.console.log('done response', resp);
    }).catch(function(exp) {
      window.console.log('done exception ', exp);
    });
  };

  let testEnd = function() {
    let file = WCT._reporter.currentRunner.name;
    let suite = WCT._reporter.currentRunner.currentRunner.suite.title;
    let test = WCT._reporter.currentRunner.currentRunner.test.title;
    let state = WCT._reporter.currentRunner.currentRunner.test.state;

    fetch('/result', {
        method: 'POST',
        body: JSON.stringify({
            'file': file,
            'suite': suite,
            'test': test,
            'state': state,
            // TODO(seanmccullough): Indicate if dom=shadow for this run.
        }),
    }).then(function(resp) {
      window.console.log('result response', resp);
    }).catch(function(exp) {
      window.console.log('result exception ', exp);
    });
  };

  // Only register these listeners when running via the golang runner.
  if (window.location.search.includes('wct=go') != -1) {
    document.addEventListener('DOMContentLoaded', function() {
      WCT._reporter.on('test end', testEnd);
      WCT._reporter.on('end', end);
    });
  }
  // END WCT MONKEYPATCH

  WCT.loadSuites(testFiles);
</script>
