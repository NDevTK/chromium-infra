<!--TODO(crbug/905380): migrate away from HTML imports.-->
<link rel="import" href="/bower_components/google-chart/google-chart.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="flake-score-chart">
  <template>
    <style>
        #dialog {
            width: 500px;
        }

        #selection-chart {
            margin-left: 0 auto;
            height: 220px;
        }
    </style>
    <paper-dialog id="dialog" opened=[[opened]]>
      <div id="chart-div">
        <google-chart
          id="selection-chart"
          type="column"
          options='{{_generateChartOptions()}}'
          data = '{{_getChartDataFromFlake(flake, weights)}}'>
        </google-chart>
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss>Close</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script type="text/javascript">
    (function () {
      "use strict";

      Polymer({
        is: "flake-score-chart",
        properties: {
          // A Flake objects to use this chart to show it's counts.
          flake: {
            type: Object
          },
          weights: {
            type: Array
          }
        },

        toggleDialog: function () {
          this.$.dialog.toggle();
        },

        _getWeight: function (flake_type, weights) {
          for (let weight_info of weights) {
            if (weight_info[0] == flake_type) {
              return weight_info[1];
            }
          }
          return -1;
        },

        _generateChartOptions: function () {
          return {
              title: 'Flake Occurrences in past 7 days',
              width: 400,
              height: 200,
              vAxes: { 0: { title: 'Counts' } },
              chartArea: {
                  right: 100
              },
              annotations: {
                  alwaysOutside: true
              },
              vAxis: { baseline: 0 }
          }
        },

        _getChartDataFromFlake: function (flake, weights) {
            let data = [];

            // Declares columns.
            data.push(['Flake Type', 'Occurrences', { 'role': 'annotation' },
                'Impacted CLs', { 'role': 'annotation'}]);
            for (let count of flake.flake_counts_last_week) {
                let row = [
                    count.flake_type + ' (W=' + this._getWeight(count.flake_type, weights) +')',
                    count.occurrence_count, 'Occ (' + count.occurrence_count +')',
                    count.impacted_cl_count, 'CL (' + count.impacted_cl_count +')'];
                data.push(row);
            }
            return data;
        }
      });
    })();
  </script>
</dom-module>
