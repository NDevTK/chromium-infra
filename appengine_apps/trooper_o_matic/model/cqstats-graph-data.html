<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="../lib/log.html">
<link rel="import" href="../lib/net.html">
<link rel="import" href="../lib/sugar.html">

<script>
function CQStatsGraphData(name) {
  this.rowItemsAvailable = true;
  this._name = name;
  this._cqStatsList = null;
  this._formattedDataCache = null;
  this._pendingResolvers = [];
}

(function() {
var cqLogHost = 'https://chromium-cq-status.appspot.com';

CQStatsGraphData.createBatch = function(project, intervalMinutes, count, names) {
  var dataList = names.map(function(name) {
    return new CQStatsGraphData(name);
  });
  var url = cqLogHost + '/stats/query?' + Object.toQueryString({
    project: project,
    interval_minutes: intervalMinutes,
    names: names.join(','),
    count: count,
  });
  net.json({url: url}).then(function(json) {
    var cqStatsList = json.results.reverse();
    dataList.forEach(function(data) {
      data._set(cqStatsList);
    });
  }).catch(log);
  return dataList.slice();
};

CQStatsGraphData.prototype._set = function(cqStatsList) {
  this._cqStatsList = cqStatsList;
  var self = this;
  this._formattedDataCache = {
    cols: ['timestamp', 'max', 'p90', 'p50', 'min', 'mean'],
    rows: cqStatsList.map(function(cqStats) {
      var stat = null;
      cqStats.stats.forEach(function(testStat) {
        if (testStat.name === self._name) {
          stat = testStat;
        }
      });
      // Convert timestamps to Date objects and seconds to minutes.
      return [
        new Date(cqStats.end * 1000),
        stat.max / 60,
        stat.percentile_90 / 60,
        stat.percentile_50 / 60,
        stat.min / 60,
        stat.mean / 60,
      ];
    }),
    unit: 'minutes',
  };
  while (this._pendingResolvers.length) {
    this._pendingResolvers.pop()(this._formattedDataCache);
  };
}

CQStatsGraphData.prototype.get = function() {
  var self = this;
  return new Promise(function(resolve) {
    if (self._formattedDataCache) {
      resolve(self._formattedDataCache);
    } else {
      self._pendingResolvers.push(resolve);
    }
  });
};

// Gets the highest ranking items that contributed to a particular row in the
// data.
CQStatsGraphData.prototype.rowItems = function(index) {
  console.assert(this._cqStatsList);
  var cqStats = this._cqStatsList[index];
  var url =
      cqLogHost + '/stats/highest/' +
      this._name + '/' + cqStats.key;
  return net.json({url: url, cache: true}).then(function(items) {
    // Convert seconds to minutes.
    items.forEach(function(item) { item[0] /= 60; });
    return {
      items: items,
      begin: new Date(cqStats.begin * 1000),
      end: new Date(cqStats.end * 1000),
    };
  });
};
})();
</script>
