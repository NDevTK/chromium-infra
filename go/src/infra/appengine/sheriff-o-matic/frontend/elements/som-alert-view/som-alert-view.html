<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../elements/som-alert-type-behavior.html">
<link rel="import" href="../../elements/som-annotation-manager-behavior.html">
<link rel="import" href="../../elements/som-header-styles.html">

<link rel="import" href="../../elements/som-alert-item/som-alert-item.html">
<link rel="import" href="../../elements/som-annotations/som-annotations.html">
<link rel="import" href="../../elements/som-bug-queue/som-bug-queue.html">
<link rel="import" href="../../elements/som-master-restarts/som-master-restarts.html">
<link rel="import" href="../../elements/som-examine/som-examine.html">
<link rel="import" href="../../elements/som-swarming-bots/som-swarming-bots.html">
<link rel="import" href="../../elements/som-tree-status/som-tree-status.html">

<dom-module id="som-alert-view">
  <template>
    <style include="som-header-styles"></style>
    <style>
      #alertList {
        display: flex;
        flex-direction: column;
      }
      #fetchAlertsError {
        color: #f00;
        margin: 1em;
      }
      #notifications {
        border-bottom: 1px solid #ddd;
        padding-bottom: 0.5em;
        margin-bottom: 1em;
      }
      .alert-item {
        box-sizing: border-box;
        float: left;
        width: 100%;
        padding: 0.5em 0;
      }
      .error {
        color: #c00;
        margin-top: 0;
      }
      .notification {
        box-sizing: border-box;
        width: 100%;
        padding: 0.5em 8px;
        margin: 0.5em auto;
        border: 1px solid #ccc;
        background: #f8f8f8;
      }
      .page-section {
        flex-grow: 0;
        flex-shrink: 0;
      }
    </style>
    <som-annotations id="annotations"
        annotations="{{annotations}}"
        bug-queue-label="[[tree.bug_queue_label]]"
        collapse-by-default="[[collapseByDefault]]"
        local-state="{{localState}}"
        user="[[user]]"
        xsrf-token="{{xsrfToken}}"></som-annotations>

    <iron-pages attr-for-selected="id" selected="[[_currentAlertView]]">
      <div id="alertList">
        <div id="notifications" class="page-section">
          <som-tree-status tree="[[tree.name]]" id="treeStatus"></som-tree-status>
          <som-master-restarts tree="[[tree.name]]" id="masterRestarts"></som-master-restarts>
          <div class="notification" hidden$="[[_isTrooperPage]]">
            Start at the top and try to clear all the alerts. For additional guidance, see:
            <span hidden$="[[!tree.help_link]]">
              <a href$="[[tree.help_link]]" target="_blank">[[tree.display_name]] Help</a>
            </span>
            <span hidden$="[[tree.help_link]]">
              <a href="/help-som">The Help Page</a>
            </span>
          </div>
          <div class="notification" hidden$="[[!_isTrooperPage]]">
            Troopers, don't forget to check <a href="http://go/trooper-pagers" target="_blank">go/trooper-pagers</a>
            and <a href="http://go/trooper-alerts" target="_blank">go/trooper-alerts</a> as well.
            For additional guidance, see: <a href="http://go/trooper" target="_blank">The Trooper Playbook</a>
          </div>
        </div>
        <div id="swarmingBots" class="page-section">
          <template is="dom-if" if="[[_showSwarmingAlerts]]">
            <som-swarming-bots bots="[[_swarmingAlerts]]"></som-swarming-bots>
          </template>
        </div>
        <div id="alertsList" class="page-section">
          <div id="fetchAlertsError" hidden$=[[!_fetchAlertsError]]>[[_fetchAlertsError]]</div>
          <template is="dom-if" if="[[!_hideJulie]]">
            <div id="noAlerts">
              <h2>Nice! There's no alerts right now. :)</h2>
              <img src="/images/jparent-jump.gif" alt="Julie Jumping" title="Julie Jumping" />
            </div>
          </template>
          <template is="dom-repeat" items="[[_computeCategories(_alerts, _isTrooperPage)]]" as="cat">
            <h2 class="category-title">
              <span>
                <span class="category-title-text">
                  [[_getCategoryTitle(cat, _isTrooperPage, trees)]] ([[_getCategoryCount(_alerts, cat, _isTrooperPage)]] total)
                </span>
                (<a href="/help-som" target="_blank">Help?</a>)
              </span>
              <div class="header-buttons">
                <span class="collapse-button" on-tap="_collapseAll">
                  <iron-icon icon="remove"></iron-icon> Collapse all
                </span>
                /
                <span class="collapse-button" on-tap="_expandAll">
                  <iron-icon icon="add"></iron-icon> Expand all
                </span>
              </div>
            </h2>
            <template is="dom-repeat" items="[[_alertItemsWithCategory(_alerts, annotations, cat, _isTrooperPage)]]" as="alert">
              <som-alert-item
                  class="alert-item"
                  tabindex="0"
                  alert="[[alert]]"
                  tree="[[tree.name]]"
                  selected="[[selected]]"
                  annotation="[[computeAnnotation(annotations, alert, collapseByDefault)]]"
                  link-style="[[linkStyle]]"
                  on-annotation-change="_handleAnnotation"
                  on-comment="_handleComment"
                  on-link-bug="_handleLinkBug"
                  on-remove-bug="_handleRemoveBug"
                  on-snooze="_handleSnooze"
                  on-group="_handleGroup"
                  on-ungroup="_handleUngroup"
                  on-resolve="_handleResolve"
                  on-opened-change="_handleOpenedChange"
              ></som-alert-item>
            </template>
          </template>
        </div>
        <som-bug-queue
          id="bugQueue"
          class="page-section"
          bugs="{{_bugs}}"
          bug-queue-label="[[tree.bug_queue_label]]"
          tree-display-name="[[tree.display_name]]"></som-bug-queue>
      </div>
      <div id="examineAlert">
        <som-alert-item
            alert="[[_examinedAlert]]"
            tree="[[tree.name]]"
            annotation="[[computeAnnotation(annotations, _examinedAlert)]]"
            link-style="[[linkStyle]]"
            on-annotation-change="_handleAnnotation"
            on-comment="_handleComment"
            on-link-bug="_handleLinkBug"
            on-remove-bug="_handleRemoveBug"
            on-snooze="_handleSnooze"
            on-group="_handleGroup"
            on-opened-change="_handleOpenedChange"
            examining
        ></som-alert-item>
        <som-examine alert="[[_examinedAlert]]" link-style="[[linkStyle]]"></som-examine>
      </div>
    </iron-pages>
  </template>
  <script src="som-alert-view.js"></script>
</dom-module>
