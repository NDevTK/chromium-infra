<!DOCTYPE html>
<head>
  <title>Build Failure</title>
  <meta charset="utf-8">
  <style>
    .running {
      color: #666666;
      background-color: #fffc6c;
      border-color: #C5C56D;
    }
    .completed {
      color: #FFFFFF;
      background-color: #8fdf5f;
      border-color: #4F8530;
    }
    .error {
      color: #FFFFFF;
      background-color: #e98080;
      border-color: #a77272;
    }
    table {
      border-collapse: collapse;
      border: 1px solid gray;
    }
    table td, th {
      border: 1px solid gray;
    }
  </style>
  <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script>
    analysisCompleted = '{{analysis_completed}}' == 'True';
    analysisFailed = '{{analysis_failed}}' == 'True';

    $(document).ready(function() {
      if (!analysisCompleted) {
        $('#status_message').text('running, will refresh in 5 seconds...');
        $('#status_message').attr('class', 'running');
        setTimeout(function(){
          {% if show_debug_info %}
          window.location.href = 'build-failure?url=https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{build_number}}&debug=1';
          {% else %}
          window.location.href = 'build-failure?url=https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{build_number}}';
          {% endif %}
        }, 5000);
      } else if (analysisFailed) {
        $('#status_message').text('error');
        $('#status_message').attr('class', 'error');
      } else {
        // TODO: use another style when no culprit CL is found.
        $('#status_message').text('completed');
        $('#status_message').attr('class', 'completed');
      }
    });
  </script>
</head>
<body>
  Findit is still under experiment. (<a href="https://code.google.com/p/chromium/issues/entry?status=Available&labels=Pri-2,findit&summary=Findit%20bug%20or%20reature%20request&comment=Url%20to%20the%20build%20Failure:%0Ahttps://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{build_number}}%0A%0AWhat%20is%20the%20bug%20or%20feature:%0A">File a Findit bug</a>)
  <br>
  <br>

  <b>Build info:</b>
  <div>
    Master: {{master_name}}<br>
    Builder: <a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}">{{builder_name}}</a><br>
    Build Number: <a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{build_number}}">{{build_number}}</a>
  </div>
  <br>

  <b>Analysis info:</b>
  <div id="analysis_info">
    status: <span id="status_message"></span>
  {% if show_debug_info %}
    {% if pipeline_status_path %}
      <a href="{{pipeline_status_path}}">pipeline</a>
    {% endif %}
    <br>
    Started: {{analysis_started | default('N/A', true)}}<br>
    Updated: {{analysis_updated}}<br>
  {% endif %}
  </div>
  <br>

  {% if analysis_completed %}
  <b>Analysis result:</b>
    {% if analysis_failed %}
      <br>
      <span class="error">No result because of some error in analysis!</span>
    {% elif analysis_result.failures|length == 0 %}
      <div>No failure is found.</div>
    {% else %}
      <div id="analysis_result">
        <table id="failures">
          <tr>
            <th rowspan="2">Step</th>
            <th rowspan="2">First Failure</th>
            <th rowspan="2">Last Pass<br>Before Failure</th>
            <th colspan="7">Suspected CLs</th>
          </tr>
          <tr>
            <th>Build Number</th>
            <th>Dependency Name</th>
            <th>Commit</th>
            <th>Score</th>
            <th>Hints</th>
          </tr>
          <tbody>
          {% for failure in analysis_result.failures %}
            {% if failure.suspected_cls|length == 0 %}
              <tr>
                <td>{{failure.step_name}}</td>
                <td><a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{failure.first_failure}}">{{failure.first_failure}}</a></td>
                {% if failure.last_pass %}
                <td><a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{failure.last_pass}}">{{failure.last_pass}}</a></td>
                {% else %}
                <td>N/A</td>
                {% endif %}
                <td colspan="5">Not found.</td>
              </tr>
            {% else %}
              {% set first_suspected_cl = failure.suspected_cls[0] %}
              <tr>
                <td rowspan="{{failure.suspected_cls|length}}">{{failure.step_name}}</td>
                <td rowspan="{{failure.suspected_cls|length}}"><a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{failure.first_failure}}">{{failure.first_failure}}</a></td>
                {% if failure.last_pass %}
                <td rowspan="{{failure.suspected_cls|length}}"><a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{failure.last_pass}}">{{failure.last_pass}}</a></td>
                {% else %}
                <td rowspan="{{failure.suspected_cls|length}}">N/A</td>
                {% endif %}

                <td><a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{first_suspected_cl.build_number}}">{{first_suspected_cl.build_number}}</a></td>
                <td>{{first_suspected_cl.dependency_name}}</td>
                <td>
                  {% if first_suspected_cl.commit_position %}
                    <a href="{{first_suspected_cl.url}}">{{first_suspected_cl.commit_position}}</a>
                  {% else %}
                    <a href="{{first_suspected_cl.url}}">{{first_suspected_cl.revision}}</a>
                  {% endif %}
                </td>
                <td>{{first_suspected_cl.score}}</td>
                <td>
                  {% for hint in first_suspected_cl.hints %}
                    <li>{{hint}}</li>
                  {% endfor %}
                </td>
              </tr>
              {# Show the remaining suspected CLs, so skip the first three columns. #}
              {% for suspected_cl in failure.suspected_cls[1:] %}
              <tr>
                <td><a href="https://build.chromium.org/p/{{master_name}}/builders/{{builder_name}}/builds/{{suspected_cl.build_number}}">{{suspected_cl.build_number}}</a></td>
                <td>{{suspected_cl.dependency_name}}</td>
                <td>
                  {% if suspected_cl.commit_position %}
                    <a href="{{suspected_cl.url}}">{{suspected_cl.commit_position}}</a>
                  {% else %}
                    <a href="{{suspected_cl.url}}">{{suspected_cl.revision}}</a>
                  {% endif %}
                </td>
                <td>{{suspected_cl.score}}</td>
                <td>
                  {% for hint in suspected_cl.hints %}
                    <li>{{hint}}</li>
                  {% endfor %}
                </td>
              </tr>
              {% endfor %}
            {% endif %}
          {% endfor %}
          </tbody>
      </div>
    {% endif %}
  {% endif %}
</body>
