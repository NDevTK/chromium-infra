<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title> Find Regression Range for Flaky Test</title>
  <style type="text/css">
    #flake-trend {
      width: 450px;
      height: 200px;
    }
  </style>
  <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.2/jquery.flot.min.js"></script>
  <script type="text/javascript">
    var findit = {};
    findit.masterName = "{{ master_name }}";
    findit.builderName = "{{ builder_name }}";
    findit.regressedBuildNumber = {{ suspected_flake_build_number or -1 }};
    findit.passRates = {{ success_rates | tojson | safe }};

    $(document).ready(function() {
      if (findit.passRates.length == 0) {
        $('#flake-trend').html('No data available yet.');
        return;
      }

      // Convert pass rate from [0, 1] to a percentage.
      $.each(findit.passRates, function(index, value) {
        value[1] = (value[1] * 100).toFixed(0);
      });

      var plot = $.plot($("#flake-trend"), [
        {
          data: findit.passRates,
        }
      ], {
        series: {
          lines: {
            show: true
          },
          points: {
            show: true
          },
          highlightColor: 'red',
        },
        grid: {
          hoverable: true,
          clickable: true,
          borderWidth: 1,
          autoHighlight: false,
        },
        xaxis:
        {
          tickDecimals: 0,
        },
        yaxis: {
          min: 0,
          max: 100,
          tickFormatter: function(val, axis) {
            return val + '%';
          },
        },
      });

      $("<div id='tooltip'></div>").css({
        position: "absolute",
        display: "none",
        border: "1px solid #fdd",
        padding: "2px",
        "background-color": "#fee",
        opacity: 0.80
      }).appendTo("body");

      function showTooltipForDataPoint(item) {
        var buildNumber = item.datapoint[0];
        var passRate = item.datapoint[1];

        $("#tooltip").html('Build #: <a href="https://build.chromium.org/p/' + findit.masterName + '/builders/' + findit.builderName + '/builds/' + buildNumber + '" target="_blank">' + buildNumber + "</a><br> Pass rate: " + passRate + '%').css({top: item.pageY + 5, left: item.pageX + 5}).show();
      }

      var dataPointSelected = false;
      $("#flake-trend").bind("plothover", function (event, pos, item) {
        if (dataPointSelected)
          return;  // A data point is selected due to a click.

        if (item) {
          showTooltipForDataPoint(item);
        } else {
          $("#tooltip").hide();
        }
      });
      $("#flake-trend").bind("plotclick", function (event, pos, item) {
        if (item) {
          dataPointSelected = true;  // Set selected data point upon click.
          showTooltipForDataPoint(item);
        } else {
          dataPointSelected = false;  // Unselect the data point.
          $("#tooltip").hide();
        }
      });

      $.each(findit.passRates, function(index, value) {
        if (value[0] == findit.regressedBuildNumber)
          plot.highlight(0, index);
      });
    });
  </script>
</head>

<body>
  <div>
    <b>Flaky Test:</b><br>
    Master: {{ master_name }} <br>
    Builder: {{ builder_name }} <br>
    Step: {{ step_name }} <br>
    Test: {{ test_name }} <br>
  </div>
  <br>
  <div>
    <b>Analysis Result:</b><br>
    Status:  {{ analysis_status }}<br>
    {% if suspected_flake_build_number %}
    Flakiness <b>started</b> in Build: <a href="https://build.chromium.org/p/{{ master_name }}/builders/{{ builder_name }}/builds/{{ suspected_flake_build_number }}" target="_blank" style="color:red;font-weight:bold">{{ suspected_flake_build_number }}</a>
    {% endif %}
  </div>
  <br>
  <div>
    <b>Pass Rate (%) by Build:</b><br>
    <div id="flake-trend"></div>
  </div>
</body>
</html>
